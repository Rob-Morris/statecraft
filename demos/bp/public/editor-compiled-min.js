(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function isEmpty(t){for(var e in t)return!1;return!0}function normalizeShuttle(t){return null==t?0:"string"==typeof t?15|VTOI[t]:t}function imageToJSON(t){const e=require("./db_legacy");switch(t.v){case null:case void 0:return e.imageToJSONv1(t);case 2:return imageToJSONv2(t);default:throw Error(`Cannot parse v${t.v} world data with this version of boilerplate`)}}function imageToJSONv2({img:t,offx:e,offy:o}){return new Promise((n,s)=>{const a=new Image;a.src=t,a.onload=function(){const t=document.createElement("canvas"),s=t.width=a.width,r=t.height=a.height,i=t.getContext("2d");i.drawImage(a,0,0,s,r);const c=i.getImageData(0,0,s,r).data,l={base:{},shuttles:{},w:s,h:r,offx:e,offy:o};for(let t=0;t<c.length;t+=4){const n=t/4,a=n%s,r=n/s|0,i=ITOV[c[t]],f=c[t+1];if("solid"!==i){const t=`${a+e},${r+o}`;l.base[t]=i,0!==f&&(l.shuttles[t]=f)}}n(l)},a.onerror=function(t){s(t)}})}function JSONToImage(t){if(isEmpty(t.base))return{base:{},shuttles:{}};const e=Number.MAX_SAFE_INTEGER;let o=e,n=-e,s=e,a=-e;for(let e in t.base){const t=parseXY(e),r=t.x,i=t.y;r<o&&(o=r),r>n&&(n=r),i<s&&(s=i),i>a&&(a=i)}const r=n-o+1,i=a-s+1,c=document.createElement("canvas");c.width=r,c.height=i;const l=c.getContext("2d"),f=l.createImageData(r,i),u=f.data;for(let t=3;t<u.length;t+=4)u[t]=255;for(let e in t.base){const n=t.base[e],a=t.shuttles[e],i=parseXY(e),c=4*(i.x-o+(i.y-s)*r);u[c]=VTOI[n],u[c+1]=normalizeShuttle(a)}return l.putImageData(f,0,0),{v:2,offx:o,offy:s,img:c.toDataURL()}}function checkConversion(t){imageToJSON(JSONToImage(t)).then(e=>{for(let o in t.base){const n=t.base[o],s=e.base[o];s!==n&&console.log("WHOA! at "+o+" "+n+" "+s)}for(let o in t.shuttles){const n=t.shuttles[o],s=e.shuttles[o];s!==n&&console.log("WHOA! at "+o+" "+n+" "+s)}}).catch(t=>{throw t})}const parseXY=t=>{const e=t.split(",");return{x:0|e[0],y:0|e[1]}};exports.fromData=function(t){return t?t.img?imageToJSON(t):Promise.resolve(t):Promise.resolve({base:{},shuttles:{},offx:0,offy:0,w:0,h:0})},exports.toData=function(t){return JSONToImage(t)};const VTOI={},ITOV=["solid","nothing","thinsolid","positive","negative","bridge","ribbon","ribbonbridge"];ITOV[64]="shuttle",ITOV[128]="thinshuttle",(()=>{for(let t=0;t<16;t++)ITOV[t+32]="ins"+(t+1);ITOV.forEach((t,e)=>{VTOI[t]=e})})();

},{"./db_legacy":2}],2:[function(require,module,exports){
function fromByte(t){const e=t&VTOI.shuttle?"shuttle":t&VTOI.thinshuttle?"thinshuttle":null;return[ITOV[63&t],e]}const VTOI={},ITOV=["solid","nothing","thinsolid","positive","negative","bridge","ribbon","ribbonbridge"];ITOV[64]="shuttle",ITOV[128]="thinshuttle",(()=>{for(let t=0;t<16;t++)ITOV[t+32]="ins"+(t+1);ITOV.forEach((t,e)=>{VTOI[t]=e})})(),exports.imageToJSONv1=function({img:t,offx:e,offy:n}){return new Promise((o,i)=>{const s=new Image;s.src=t,s.onload=function(){const t=document.createElement("canvas"),i=t.width=s.width,h=t.height=s.height,r=t.getContext("2d");r.drawImage(s,0,0,i,h);const f=r.getImageData(0,0,i,h).data,l={base:{},shuttles:{},w:i,h:h,offx:e,offy:n};for(let t=0;t<f.length;t++){if(t%4==3)continue;const o=t%(4*i),s=o-(o-o%4)/4,h=t/(4*i)|0,r=fromByte(f[t]),a=r[0],c=r[1];if("solid"!==a){const t=s+e+","+(h+n);l.base[t]=a,c&&(l.shuttles[t]=c)}}o(l)},s.onerror=function(t){i(t)}})};

},{}],3:[function(require,module,exports){
require("isomorphic-fetch");const util=require("boilerplate-jit").util,Boilerplate=require("../lib/boilerplate"),modules=require("./modules"),db=require("./db");window.util=util;var readonly=!1;const el=document.getElementById("bp"),playpausebutton=document.getElementById("playpause"),stepbutton=document.getElementById("step"),worldNameLabel=document.getElementById("worldname");var worldName=null;(()=>{const e=location.pathname.split("/"),n=decodeURIComponent(e[e.length-2]),t=decodeURIComponent(e[e.length-1]);worldName=`${n}/${t}`,worldNameLabel.textContent=worldName})();const loadGrid=()=>{const e=location.pathname+".json";return console.log("loading from "+e),fetch(e,{headers:{Accept:"application/json"},credentials:"same-origin"}).then(e=>404===e.status?{}:e.json()).then(e=>(e&&e.readonly&&(document.getElementById("readonly").style.display="inline"),readonly=!!e.readonly,document.title=`${worldName} - Steamdance`,db.fromData(e.data)))},bpromise=(()=>{const e=location.pathname+".json";return console.log("loading from "+e),fetch(e,{headers:{Accept:"application/json"},credentials:"same-origin"}).then(e=>404===e.status?{}:e.json()).then(e=>(e&&e.readonly&&(document.getElementById("readonly").style.display="inline"),readonly=!!e.readonly,document.title=`${worldName} - Steamdance`,db.fromData(e.data)))})().then(e=>{const n=window.bp=new Boilerplate(el,{grid:e,animTime:200});return el.focus(),n.addKeyListener(window),e.w&&e.w>30&&n.view.fit(e.w,e.h,e.offx||0,e.offy||0),n});var running=!1,timer=null,unsavedMovement=!1;const setRunning=e=>{document.getElementById("playpanel").className=e?"running":"stopped",running!==e&&(running=e,e?(playpausebutton.textContent="||",timer=setInterval(()=>{bpromise.then(e=>unsavedMovement|=e.step())},200)):(playpausebutton.textContent="►",clearInterval(timer)))},autoplay="#play"===window.location.hash;setRunning(autoplay);const isEmpty=e=>{for(var n in e)return!1;return!0},saveNow=()=>bpromise.then(e=>{if(readonly)return;const n=e.getJSONGrid(),t=isEmpty(n.base)&&isEmpty(n.shuttles);return t&&console.log("removing"),fetch(location.pathname+".json",{method:t?"DELETE":"PUT",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:t?null:JSON.stringify({data:db.toData(n)})}).catch(e=>console.error(e))}),save=(()=>{if(readonly)return;var e=0,n=-1;return()=>{const t=Date.now();t-e>2e3?(saveNow(),e=t):-1===n&&(n=setTimeout(()=>{saveNow(),n=-1,e=Date.now()},e+2e3-t))}})();bpromise.then(e=>{e.onEditFinish=save,setInterval(()=>{unsavedMovement&&(save(),unsavedMovement=!1)},15e3)}),window.addEventListener("keypress",e=>{switch(32!==e.keyCode&&32!==e.which||setRunning(!running),e.keyCode){case 13:bpromise.then(e=>e.step())}}),window.onresize=(()=>bpromise.then(e=>{e.resizeTo(window.innerWidth,window.innerHeight)})),playpausebutton.onclick=(e=>setRunning(!running)),stepbutton.onclick=(e=>bpromise.then(e=>{e.step()})),bpromise.then(e=>{const n=document.getElementsByClassName("toolpanel")[0];var t=null;n.onclick=(t=>{const o=t.target;o!==n&&e.changeTool(o.id)}),e.onToolChanged=(e=>{t&&(t.className="");const n=document.getElementById(e||"solid");n&&(n.className="selected",t=n)}),e.onToolChanged(e.activeTool),modules.load(e)});

},{"../lib/boilerplate":5,"./db":1,"./modules":4,"boilerplate-jit":13,"isomorphic-fetch":20}],4:[function(require,module,exports){
const util=require("boilerplate-jit").util,Boilerplate=require("../lib/boilerplate"),fl=Math.floor,moduleData=[];var selectedModule=null;const elementForModuleData=new Map,addModElem=document.getElementById("addmod"),selectModule=e=>{e!==selectedModule&&(selectedModule&&(selectedModule.classList.remove("selected"),selectedModule=null),e&&(e.classList.add("selected"),addModElem.style.display="none",selectedModule=e))};addModElem.style.display="none";const drawTo=(e,l,t)=>{e.base.forEach((o,d,a)=>{const s=o*l,n=d*l;a=util.shuttleStr(e.shuttles.get(o,d))||a,t.fillStyle=Boilerplate.colors[a],t.fillRect(s,n,l,l)})},save=()=>{const e=moduleData.map(e=>{const l={base:{},shuttles:{}};return l.tw=e.tw,l.th=e.th,e.base.forEach((e,t,o)=>l.base[[e,t]]=o),e.shuttles.forEach((e,t,o)=>l.shuttles[[e,t]]=o),l});localStorage.setItem("bp modules",JSON.stringify(e))},addModule=exports.addModule=((e,l)=>{const t=document.getElementById("moduleList");moduleData.push(e);const o=document.createElement("div");o.className="module",elementForModuleData.set(e,o),t.insertBefore(o,addModElem.nextSibling);const d=document.createElement("canvas");o.appendChild(d);const a=document.createElement("div");if(a.classList.add("rm"),a.textContent="⌫",o.appendChild(a),null==e.tw)throw Error("need w/h");const s=e.tw,n=e.th,c=d.clientWidth,i=d.clientHeight,u=fl(Math.min(c/s,i/n));d.width=c*devicePixelRatio,d.height=i*devicePixelRatio;const r=d.getContext("2d");return r.scale(devicePixelRatio,devicePixelRatio),r.translate(fl((c-u*s)/2),fl((i-u*n)/2)),drawTo(e,u,r),r.strokeStyle="rgba(0,255,255,0.5)",r.lineWidth=1,r.strokeRect(1,1,u*s-2,u*n-2),o.onclick=(()=>{selectModule(o),l.setSelection(e)}),a.onclick=(l=>{selectedModule===o&&(selectModule(null),addModElem.style.display="inherit"),delete a.onclick,delete o.onclick,t.removeChild(o),elementForModuleData.delete(e);const d=moduleData.indexOf(e);moduleData.splice(d,1),l.stopPropagation(),save()}),save(),o});exports.load=(e=>{const l=JSON.parse(localStorage.getItem("bp modules")||"[]");for(var t=0;t<l.length;t++)addModule(util.deserializeRegion(l[t]),e);e.onSelection=(e=>{var l=elementForModuleData.get(e);l?selectModule(l):(selectModule(null),addModElem.style.display="inherit")}),(e.onSelectionClear=(()=>{selectModule(null),addModElem.style.display="none"}))(),addModElem.onclick=(()=>{const l=e.selection;if(l){const t=addModule(l,e);selectModule(t)}})});

},{"../lib/boilerplate":5,"boilerplate-jit":13}],5:[function(require,module,exports){
function BlobBounds(t){t.addWatch.on(t=>{var e=-1<<30,s=-1<<30,i=1<<30,h=1<<30,o=t.points,l=t.edges;(o.size<l.size?o:l).forEach((t,o)=>{t<i&&(i=t),o<h&&(h=o),t>s&&(s=t),o>e&&(e=o)}),t.bounds={left:i,top:h,right:s,bottom:e}})}function PrevState(t,e,s){var i=new Map;return t.deleteWatch.on(t=>i.delete(t)),e.watch.on((t,e)=>{e&&(i.has(t)||i.set(t,e))}),s.on(t=>{"before"===t&&i.clear()}),{get:t=>i.get(t)}}function addModules(t){const e=t.modules.stepWatch=new Watcher,{shuttles:s,engines:i,currentStates:h}=t.modules;BlobBounds(s),BlobBounds(i);const o=PrevState(s,h,e);t.modules.prevState=o}function line(t,e,s,i,h){const o=Math.abs(s-t),l=Math.abs(i-e),r=t<s?1:-1,n=e<i?1:-1;for(var a=0,d=0;d<=o+l;d++){h(t,e);var c=a+l,u=a-o;Math.abs(c)<Math.abs(u)?(t+=r,a=c):(e+=n,a=u)}}function enclosingRect(t,e){return{tx:Math.min(t.tx,e.tx),ty:Math.min(t.ty,e.ty),tw:Math.abs(e.tx-t.tx)+1,th:Math.abs(e.ty-t.ty)+1}}const{Jit:Jit,Map2:Map2,Map3:Map3,Set2:Set2,Set3:Set3,Watcher:Watcher,util:util}=require("boilerplate-jit"),COLORS=require("./colors"),DIRS=util.DIRS,{letsShuttleThrough:letsShuttleThrough,lerp:lerp,clamp:clamp}=require("./util"),View=require("./view"),GLRenderer=require("./gl"),SHUTTLE=64,THINSHUTTLE=128,UP=0,RIGHT=1,DOWN=2,LEFT=3,fl=Math.floor,KEY={up:1,right:2,down:4,left:8,shift:16},svStr=t=>"string"==typeof t?t:null==t?"null":(64&t?"S":"A")+Array.prototype.map.call("urdl",(e,s)=>t&1<<s?e:"_").join("");class Boilerplate{changeTool(t){this.activeTool="solid"===t?null:t,this.onToolChanged&&this.onToolChanged(this.activeTool),this.updateCursor()}addKeyListener(t){t.addEventListener("keydown",t=>{const e=t.keyCode;var s={49:"nothing",50:"thinsolid",51:"solid",52:"positive",53:"negative",54:"shuttle",55:"thinshuttle",56:"bridge",57:"ribbon",80:"positive",78:"negative",83:"shuttle",65:"thinshuttle",69:"nothing",71:"thinsolid",68:"solid",66:"bridge",82:"ribbon"}[e];if(t.ctrlKey){const i=t.shiftKey?8:0;49<=e&&e<=57&&(s=`ins${e-48+i}`),"nothing"===s&&(s="bridge"),"ribbon"===s&&(s="ribbonbridge")}if(s)if(this.selection)for(var i=0;i<this.selection.tw;i++)for(var h=0;h<this.selection.th;h++)"solid"===s?(this.selection.base.delete(i,h),this.selection.shuttles.delete(i,h)):"shuttle"===s||"thinshuttle"===s?(letsShuttleThrough(this.selection.base.get(i,h))||this.selection.base.set(i,h,"nothing"),this.selection.shuttles.set(i,h,s)):(this.selection.base.set(i,h,s),this.selection.shuttles.delete(i,h));else this.changeTool(s);switch(37<=t.keyCode&&t.keyCode<=40&&(this.lastKeyScroll=Date.now()),e){case 37:this.keysPressed|=KEY.left;break;case 39:this.keysPressed|=KEY.right;break;case 38:this.keysPressed|=KEY.up;break;case 40:this.keysPressed|=KEY.down;break;case 16:this.keysPressed|=KEY.shift,this.imminentSelect=!0;break;case 27:case 192:this.selection?this.clearSelection():this.changeTool("move");break;case 190:this.view.snap(this.mouse),this.drawAll();break;case 88:this.selection&&this.flip("x");break;case 89:this.selection&&this.flip("y");break;case 77:this.selection&&this.mirror();break;case 187:case 189:var o=Math.max(1,this.view.size/8)/20;189===e&&(o*=-1),this.keysPressed&KEY.shift&&(o*=3),this.view.zoomBy(o,{x:this.width/2,y:this.height/2})}(t.ctrlKey||t.metaKey)&&90===e?(t.shiftKey?this.redo():this.undo(),t.preventDefault()):t.ctrlKey&&89===e&&(this.redo(),t.preventDefault()),this.draw()}),t.addEventListener("keyup",t=>{switch(37<=t.keyCode&&t.keyCode<=40&&(this.lastKeyScroll=Date.now()),t.keyCode){case 16:this.keysPressed&=~KEY.shift,this.imminentSelect=!1,this.draw();break;case 37:this.keysPressed&=~KEY.left;break;case 39:this.keysPressed&=~KEY.right;break;case 38:this.keysPressed&=~KEY.up;break;case 40:this.keysPressed&=~KEY.down}}),t.addEventListener("blur",()=>{this.mouse.mode=null,this.imminentSelect=!1,this.editStop(),this.draw()}),t.addEventListener("copy",t=>this.copy(t)),t.addEventListener("paste",t=>this.paste(t))}set(t,e,s,i){const h=this.jit.get("base",t,e)||null;var o=this.jit.get("shuttles",t,e)||null;return(s!=h||o!=i)&&(this.onEdit(t,e,h,o),this.jit.set(t,e,s,i),!0)}resetView(){this.view.reset(this.options)}setJSONGrid(t){this.jit=Jit(t),addModules(this.jit),this.gridRenderer.addModules(this.jit),this.jit.modules.shuttles.deleteWatch.on(t=>{this.draggedShuttle&&t===this.draggedShuttle.shuttle&&(this.draggedShuttle=null)}),this.currentEdit=null,this.undoStack.length=this.redoStack.length=0,this.drawAll()}getJSONGrid(){return this.jit.toJSON()}constructor(t,e){this.el=t,this.options=e||{},this.keysPressed=0,this.lastKeyScroll=0,this.activeTool="move",this.currentEdit=null,this.undoStack=[],this.redoStack=[],this.view=new View(this.el.offsetWidth,this.el.offsetHeight,this.options),this.canScroll=null==this.options.canScroll||this.options.canScroll,this.animTime=this.options.animTime||0,-1===this.el.tabIndex&&(this.el.tabIndex=0),this.gridCanvas=this.el.appendChild(document.createElement("canvas")),this.gridCanvas.className="draw",this.gridCanvas.style.backgroundColor=COLORS.solid,this.dynCanvas=this.el.appendChild(document.createElement("canvas")),this.dynCanvas.className="draw",this.el.boilerplate=this,this.gridRenderer=new GLRenderer(this.gridCanvas,this.view),this.setJSONGrid(this.options.grid),this.mouse={x:null,y:null,mode:null},this.imminentSelect=!1,this.selectedA=this.selectedB=null,this.selectOffset=null,this.selection=null,this.drawAll(),this.view.watch.forward(t=>{this.width=t.width,this.height=t.height,this.dynCanvas.width=t.width*devicePixelRatio,this.dynCanvas.height=t.height*devicePixelRatio,this.dctx=this.dynCanvas.getContext("2d"),this.dctx.scale(devicePixelRatio,devicePixelRatio),this.drawAll()}),this.el.onmousemove=(t=>{this.imminentSelect=!!t.shiftKey,t.button&&!this.mouse.mode&&this.el.onmousedown(t),this.updateMousePos(t)&&this.cursorMoved(),"pan"===this.mouse.mode&&this.view.scrollBy(-this.mouse.dx,-this.mouse.dy),this.mouse&&this.jit.get("base",this.mouse.tx,this.mouse.ty)&&this.draw()}),this.el.onmousedown=(t=>{if(this.updateMousePos(t),1===t.button)this.mouse.mode="pan";else if(t.shiftKey)this.mouse.mode="select",this.clearSelection(),this.selectedA=this.view.screenToWorld(this.mouse.x,this.mouse.y),this.selectedB=this.selectedA;else if(this.selection)this.stamp();else if("move"===this.activeTool){const t=this.jit.modules.shuttleGrid.getShuttle(this.mouse.tx,this.mouse.ty);if(t){const e=t.currentState.dx,s=t.currentState.dy;this.draggedShuttle={shuttle:t,heldPoint:{x:this.mouse.tx-e,y:this.mouse.ty-s}},t.held=!0}}else this.mouse.mode="paint",this.mouse.from={tx:this.mouse.tx,ty:this.mouse.ty},this.mouse.direction=null,this.editStart(),this.paint();this.updateCursor(),this.draw()}),this.el.onmouseup=(()=>{this.draggedShuttle&&(this.draggedShuttle.shuttle.held=!1,this.draggedShuttle=null),"select"===this.mouse.mode?(this.selection=this.copySubgrid(enclosingRect(this.selectedA,this.selectedB)),this.selectOffset={tx:this.selectedB.tx-Math.min(this.selectedA.tx,this.selectedB.tx),ty:this.selectedB.ty-Math.min(this.selectedA.ty,this.selectedB.ty)},this.onSelection&&this.onSelection(this.selection)):"paint"===this.mouse.mode&&(this.editStop(),this.onEditFinish&&this.onEditFinish()),this.mouse.mode=null,this.mouse.direction=null,this.imminentSelect=!1,this.updateCursor(),this.draw()}),this.el.onmouseout=(t=>{this.el.onmousemove(t),this.mouse.x=this.mouse.y=this.mouse.from=this.mouse.tx=this.mouse.ty=null,this.mouse.mode=null,this.draw()}),this.el.onmouseenter=(t=>{t.button&&(this.el.onmousemove(t),this.el.onmousedown(t))}),this.el.onwheel=(t=>{if(!this.canScroll)return;this.updateMousePos(t),t.shiftKey||t.ctrlKey?this.view.zoomBy(-(t.deltaY+t.deltaX)/400,this.mouse):this.view.scrollBy(t.deltaX,t.deltaY);const e=this.view.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.tx=e.tx,this.mouse.ty=e.ty,t.preventDefault(),this.cursorMoved()})}updateMousePos(t){if(this.mouse.from={tx:this.mouse.tx,ty:this.mouse.ty},t){const e=this.mouse.x,s=this.mouse.y;this.mouse.x=clamp(t.offsetX,0,this.el.offsetWidth-1),this.mouse.y=clamp(t.offsetY,0,this.el.offsetHeight-1),this.mouse.dx=this.mouse.x-e,this.mouse.dy=this.mouse.y-s}const{tx:e,ty:s,tc:i}=this.view.screenToWorldCell(this.mouse.x,this.mouse.y,this.jit);return(e!==this.mouse.tx||s!==this.mouse.ty||i!==this.mouse.tc)&&(this.mouse.tx=e,this.mouse.ty=s,this.mouse.tc=i,!0)}cursorMoved(){switch(this.mouse.mode){case"paint":this.paint();break;case"select":this.selectedB=this.view.screenToWorld(this.mouse.x,this.mouse.y)}null!=this.draggedShuttle&&this.dragShuttleTo(this.mouse.tx,this.mouse.ty),this.draw(),this.updateCursor()}updateCursor(){var t;if("move"!==this.activeTool||this.imminentSelect)switch(this.mouse.direction){case"x":t="ew-resize";break;case"y":t="ns-resize";break;default:t="crosshair"}else t=this.draggedShuttle?"-webkit-grabbing":this.jit.modules.shuttleGrid.getShuttle(this.mouse.tx,this.mouse.ty)?"-webkit-grab":"default";this.dynCanvas.style.cursor=t}resizeTo(t,e){this.view.resizeTo(t,e)}paint(){if("move"===this.activeTool)throw Error("Invalid placing");const{tx:t,ty:e}=this.mouse;var{tx:s,ty:i}=this.mouse.from;null==s&&(s=t),null==i&&(i=e),line(s,i,t,e,(t,e)=>{if("shuttle"===this.activeTool||"thinshuttle"===this.activeTool){var h=this.jit.get("base",t,e);letsShuttleThrough(h)||(h="nothing");var o="shuttle"===this.activeTool?64:128;const l=this.jit.get("shuttles",t,e);null!=l&&(o|=15&l),s<t?o|=8:s>t&&(o|=2),i<e?o|=1:i>e&&(o|=4),this.set(t,e,h,o)}else this.set(t,e,this.activeTool,null);s=t,i=e}),this.drawAll()}step(){this.jit.modules.stepWatch.signal("before");const t=this.jit.step();return t&&(this.lastStepAt=Date.now(),this.drawAll(),this.updateCursor()),this.jit.modules.stepWatch.signal("after"),t}dragShuttleTo(t,e){if(null==this.draggedShuttle)return;const{shuttle:s,heldPoint:i}=this.draggedShuttle,h=t-i.x,o=e-i.y;var l=s.currentState;const{shuttleStates:r,shuttleOverlap:n}=this.jit.modules;var a;const d=t=>{a||(a=r.getStateNear(l,t),n.willOverlap(s,a)&&(a=null))};for(;l.dx!==h||l.dy!==o;){const t=h-l.dx,e=o-l.dy;if(a=null,t<0?d(3):t>0&&d(1),e<0?d(0):e>0&&d(2),!a)break;l=a}s.currentState!==l&&(this.jit.moveShuttle(s,l),this.drawAll())}editStart(){this.editStop(),this.currentEdit={base:new Map2,shuttles:new Map2}}onEdit(t,e,s,i){this.currentEdit&&!this.currentEdit.base.has(t,e)&&(this.currentEdit.base.set(t,e,s),null!=i&&DIRS.forEach((s,h)=>{const o=this.currentEdit.shuttles.get(t+s.dx,e+s.dy);null!=o&&(o&1<<util.oppositeDir(h)?i|=1<<h:i&=~(1<<h))}),this.currentEdit.shuttles.set(t,e,i))}editStop(t){null==t&&(t=this.undoStack),this.currentEdit&&((this.currentEdit.base.size||this.currentEdit.shuttles.size)&&t.push(this.currentEdit),this.currentEdit=null)}_popStack(t,e){this.editStop();var s=t.pop();s&&(this.editStart(),s.base.forEach((t,e,i)=>this.set(t,e,i,s.shuttles.get(t,e)))),this.editStop(e),this.drawAll()}redo(){this._popStack(this.redoStack,this.undoStack)}undo(){this._popStack(this.undoStack,this.redoStack)}copySubgrid(t){const{tx:e,ty:s,tw:i,th:h}=t,o={tw:i,th:h,base:new Map2,shuttles:new Map2};for(var l=s;l<s+h;l++)for(var r=e;r<e+i;r++){const t=this.jit.get("base",r,l),i=this.jit.get("shuttles",r,l);t&&o.base.set(r-e,l-s,t),i&&o.shuttles.set(r-e,l-s,i)}return o}_transformSelection(t,e,s,i){if(!this.selection)return;const h={tw:t,th:e,base:new Map2,shuttles:new Map2};this.selection.base.forEach(i(h.base));const o=i(h.shuttles);return this.selection.shuttles.forEach((t,e,i)=>o(t,e,s(i))),this.selection=h}flip(t){if(!this.selection)return;const{tw:e,th:s}=this.selection;this._transformSelection(e,s,e=>240&e|("x"===t?5&e|(2&e)<<2|(8&e)>>2:10&e|(1&e)<<2|(4&e)>>2),i=>(h,o,l)=>{const r="x"===t?e-1-h:h,n="y"===t?s-1-o:o;i.set(r,n,l)})}mirror(){if(!this.selection)return;this._transformSelection(this.selection.th,this.selection.tw,t=>240&t|(8&t)>>3|(1&t)<<3|(4&t)>>1|(2&t)<<1,t=>(e,s,i)=>t.set(s,e,i))}stamp(){if(!this.selection)throw new Error("tried to stamp without a selection");var{tx:t,ty:e}=this.view.screenToWorld(this.mouse.x,this.mouse.y);t-=this.selectOffset.tx,e-=this.selectOffset.ty;var s=!1;this.editStart();for(var i=0;i<this.selection.th;i++)for(var h=0;h<this.selection.tw;h++){const o=this.selection.base.get(h,i),l=this.selection.shuttles.get(h,i);this.set(t+h,e+i,o,l)&&(s=!0)}this.editStop(),this.onEditFinish&&this.onEditFinish(),s&&this.drawAll()}clearSelection(){this.selection&&(this.selection=this.selectOffset=null,this.onSelectionClear&&this.onSelectionClear())}setSelection(t){this.clearSelection(),null!=t&&(this.selection=t,this.selectOffset={tx:0,ty:0},this.onSelection&&this.onSelection(this.selection))}copy(t){var e;this.selection?(e={tw:this.selection.tw,th:this.selection.th,base:{},shuttles:{}},this.selection.base.forEach((t,s,i)=>{null!=i&&(e.base[`${t},${s}`]=i)}),this.selection.shuttles.forEach((t,s,i)=>{null!=i&&(e.shuttles[`${t},${s}`]=i)})):e=this.getJSONGrid(),t.clipboardData.setData("text",JSON.stringify(e)),t.preventDefault()}paste(t){const e=t.clipboardData.getData("text");if(e)try{this.selection=util.deserializeRegion(e),this.selectOffset={tx:0,ty:0},this.onSelection&&this.onSelection(this.selection)}catch(t){this.selection=null,console.error("Error parsing data in clipboard:",t.stack)}}drawAll(){this.needsDrawAll=!0,this.draw()}draw(){this.needsDraw||(this.needsDraw=!0,requestAnimationFrame(()=>{if(this.needsDraw=!1,this.needsDrawAll&&(this.jit.modules.shuttles.flush(),this.needsDrawAll=!1),15&this.keysPressed&&this.canScroll){const e=Date.now();var t=.6*Math.min(e-this.lastKeyScroll,300);this.keysPressed&KEY.shift&&(t*=3),this.keysPressed&KEY.up&&this.view.scrollBy(0,-t),this.keysPressed&KEY.right&&this.view.scrollBy(t,0),this.keysPressed&KEY.down&&this.view.scrollBy(0,t),this.keysPressed&KEY.left&&this.view.scrollBy(-t,0),this.lastKeyScroll=e,this.updateMousePos()&&this.cursorMoved()}this.dctx.clearRect(0,0,this.width,this.height),this.drawGrid(),this.drawOverlay(),this.keysPressed&&this.draw()}))}drawCells(t,e,s){const i=this.view.size;e.forEach((e,h,o)=>{const{px:l,py:r}=this.view.worldToScreen(e,h);if(l+i<0||l>=this.width||r+i<0||r>=this.height)return;const n="function"==typeof s?s(e,h,o):s||(COLORS[o]||"red");null!=n&&(t.fillStyle=n,t.fillRect(l,r,i,i))})}__old_pathAroundEdge(t,e,s,i){const h=i?i.sx:0,o=i?i.sy:0,l=(e,i,l,r,n)=>{var a=0===l||1===l?e+1:e,d=1===l||2===l?i+1:i;a+=h,d+=o;var{px:c,py:u}=this.view.worldToScreen(a,d);const{dx:m,dy:y}=DIRS[l];c+=s*(-m-y*r),u+=s*(m*r-y),n?t.moveTo(c,u):t.lineTo(c,u)},r=new Set3;t.beginPath(),e.forEach((s,i,h)=>{if(!r.has(s,i,h)){for(var o=!0;!r.has(s,i,h);){r.add(s,i,h);const{dx:t,dy:c}=DIRS[h];var n,a,d;e.has(n=s+t-c,a=i+c+t,d=(h+3)%4)&&!e.has(s,i,(h+1)%4)?(l(s,i,h,1,o),s=n,i=a,h=d,o=!1):e.has(n=s-c,a=i+t,h)?(s=n,i=a):(l(s,i,h,-1,o),h=(h+1)%4,o=!1)}t.closePath()}})}drawEngine(t,e){this.__old_pathAroundEdge(this.dctx,t.edges,2),this.dctx.strokeStyle="positive"===t.type?"hsl(120, 52%, 26%)":"hsl(16, 68%, 20%)",this.dctx.lineWidth=4,this.dctx.stroke()}drawGrid(){var t=!1,e=1;if(this.animTime&&this.lastStepAt){const t=(Date.now()-this.lastStepAt)/this.animTime;e=Math.min(1,(t*this.view.size|0)/this.view.size)}const s=this.mouse.x,i=this.mouse.y,{tx:h,ty:o,tc:l}=this.view.screenToWorldCell(s,i,this.jit),r={};if("move"===this.activeTool&&!this.selection&&!this.imminentSelect){const t=this.jit.get("base",h,o),s=util.shuttleStr(this.jit.get("shuttles",h,o)),i=this.jit.modules;r.shuttle=i.shuttleGrid.getShuttle(h,o);const a=i.engineGrid.get(h,o);a&&this.drawEngine(a,e);var n;"shuttle"!==s&&t&&(n=this.jit.getZoneContents(h,o,l))&&(r.points=n.points,r.pressure=0,n.engines.forEach(t=>{r.pressure+=t.pressure,this.drawEngine(t,e)}))}if(this.gridRenderer.draw(e,r)&&(t=!0),r.points&&this.drawCells(this.dctx,r.points,"rgba(100,100,100,0.3)"),r.pressure){const t=s,e=i+20;var a=23;const h=""+r.pressure;for(;a>3&&(this.dctx.font=`${fl(a)}px sans-serif`,!(this.dctx.measureText(h).width<20));)a--;this.dctx.fillStyle="rgba(0, 0, 0, 0.5)",this.dctx.fillRect(t,e,23,23),this.dctx.fillStyle=r.pressure<0?COLORS.negative:COLORS.positive,this.dctx.textBaseline="middle",this.dctx.textAlign="center",this.dctx.fillText(h,t+11.5,e+11.5)}1!==e&&t&&this.draw()}drawOverlay(){const t=this.mouse.x,e=this.mouse.y,{tx:s,ty:i}=this.view.screenToWorld(t,e),{px:h,py:o}=this.view.worldToScreen(s,i);var l,r;"select"===this.mouse.mode?(l=this.selectedA,r=this.selectedB):this.imminentSelect&&(l=r={tx:s,ty:i}),this.dctx.lineWidth=1;const n=this.view.size;if(null!==this.mouse.tx)if(l){const{tx:t,ty:e,tw:s,th:i}=enclosingRect(l,r),{px:h,py:o}=this.view.worldToScreen(t,e);this.dctx.fillStyle="rgba(0,0,255,0.5)",this.dctx.fillRect(h,o,s*n,i*n),this.dctx.strokeStyle="rgba(0,255,255,0.5)",this.dctx.strokeRect(h,o,s*n,i*n)}else if(this.selection){this.dctx.globalAlpha=.8;for(var a=0;a<this.selection.th;a++)for(var d=0;d<this.selection.tw;d++){const{px:t,py:e}=this.view.worldToScreen(d+s-this.selectOffset.tx,a+i-this.selectOffset.ty);if(t+n>=0&&t<this.width&&e+n>=0&&e<this.height){var c=this.selection.shuttles.get(d,a)||this.selection.base.get(d,a);"number"==typeof c&&(c=util.shuttleStr(c)),this.dctx.fillStyle=(c?COLORS[c]:COLORS.solid)||"red",this.dctx.fillRect(t,e,n,n)}}this.dctx.strokeStyle="rgba(0,255,255,0.5)",this.dctx.strokeRect(h-this.selectOffset.tx*n,o-this.selectOffset.ty*n,this.selection.tw*n,this.selection.th*n),this.dctx.globalAlpha=1}else null!=h&&"move"!==this.activeTool&&(this.dctx.fillStyle=COLORS[this.activeTool||"solid"]||"red",this.dctx.fillRect(h+n/4,o+n/4,n/2,n/2),this.dctx.strokeStyle=this.jit.get("base",s,i)?"black":"white",this.dctx.strokeRect(h+1,o+1,n-2,n-2))}}module.exports=Boilerplate,Boilerplate.colors=COLORS;

},{"./colors":6,"./gl":7,"./util":9,"./view":10,"boilerplate-jit":13}],6:[function(require,module,exports){
const COLORS=module.exports={bridge:"rgb(26, 126, 213)",negative:"hsl(16, 68%, 50%)",nothing:"hsl(0, 0%, 100%)",positive:"hsl(120, 52%, 58%)",shuttle:"hsl(283, 65%, 45%)",solid:"hsl(184, 49%, 7%)",thinshuttle:"hsl(283, 89%, 75%)",thinsolid:"hsl(0, 0%, 71%)",ribbon:"rgb(185, 60, 174)",ribbonbridge:"rgb(108, 30, 217)"};(()=>{for(var s=1;s<=8;s++)COLORS[`ins${s}`]=`hsl(188, ${24+6*s}%, ${43-2*s}%)`,COLORS[`ins${s+8}`]=`hsl(44, #{24 + 6 * i}%, #{43 - 2*i}%)`})();

},{}],7:[function(require,module,exports){
function FrameTimer(e,t,r){function s(){i||o.signal(++n)}let n=1,o=new Watcher(()=>n),i=!1;return r.on(e=>{"before"===e?i=!0:"after"===e&&(i=!1,o.signal(++n))}),e.watch.on(s),t.addWatch.on(s),t.deleteWatch.on(s),{watch:o,get:()=>n}}function GroupsWithPressure(e,t,r,s,n,o){function i(e){const t={regions:new Set,pressure:0,seeds:[]},r=s.get(e,o.map);jitutil.fillGraph(r,(e,r)=>{t.regions.add(e),e.groups.forEach(e=>{c.has(e)&&(t.seeds.push(e),c.delete(e))}),e.edges.forEach(e=>{const t=s.get(e,o.map);t&&r(t)})});const i=n.getZoneForRegion(r);return t.pressure=i.pressure,f.set(i,t),h.add(t),t}function l(e){e.engines.forEach(t=>{t.used&&t.edges.forEach((t,r,s)=>{e.points.has(t,r,s)&&a.push({x:t,y:r,c:s})})})}const a=[],c=new Set,h=new Set,u=[],f=new WeakMap,d=new Watcher(e=>{const t=[];h.forEach(e=>t.push(pressure)),e([],t)});return t.addWatch.forward(e=>{e.edges.forEach((e,t,r)=>{a.push({x:e,y:t,c:r})})}),e.afterWatch.on((t,r,s,n)=>{if(null!=n)for(var o=0;o<4;o++){const{dx:s,dy:n}=DIRS[o],i=e.get(t+s,r+n);"positive"!==i&&"negative"!==i||a.push({x:t+s,y:r+n,c:jitutil.oppositeDir(o)})}}),r.deleteWatch.on(e=>{c.delete(e)&&l(e)}),n.watch.on(e=>{const t=f.get(e);if(t){u.push(t);for(var r=0;r<t.seeds.length;r++){const e=t.seeds[r];e.used?c.add(e):l(e)}h.delete(t)}}),{watch:d,flush(){if(t.flush(),a.length){for(var s=0;s<a.length;s++){const{x:t,y:n,c:o}=a[s],i=e.get(t,n);if("positive"!==i&&"negative"!==i)continue;const l=r.get(t,n,o);l&&c.add(l)}a.length=0}const n=[];c.forEach(e=>{n.push(i(e))}),d.signal(u,n),u.length=0}}}function Tiles(e,t,r,s,n){const o=new Map2(function(t,r){return{lastFlush:-1,count:0,data:new Uint8Array(TILE_SIZE*TILE_SIZE),dirty:!1,tex:-1,bind(){-1==this.tex?(this.tex=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.dirty=!0):e.bindTexture(e.TEXTURE_2D,this.tex),this.dirty&&(e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,TILE_SIZE,TILE_SIZE,0,e.LUMINANCE,e.UNSIGNED_BYTE,this.data),this.dirty=!1)}}});return t.afterWatch.forward((t,r,s,n)=>{const i=T(t),l=T(r),a=O(t),c=O(r),h=o.getDef(i,l);null!=s&&h.count--,null!=n&&h.count++,h.dirty=!0,h.data[a+c*TILE_SIZE]=TEXMAP[n],0==h.count&&(o.delete(i,l),-1!=h.tex&&e.deleteTexture(h.tex))}),{data:o,get:(e,t)=>o.get(T(e),T(t)),cleanup(){o.forEach(t=>{-1!=t.tex&&e.deleteTexture(t.tex)})},onContextLost(){o.forEach((e,t,r)=>r.tex=-1)},setPressure(e,t){let r=0,s=0,n=null;e.points.forEach((e,i,l,a)=>{if("nothing"===a||"thinsolid"===a){const l=T(e),a=T(i),c=O(e),h=O(i);if(null!==n&&l===r&&a===s||(n=o.get(l,a),r=l,s=a),void 0===n)return;const u=c+h*TILE_SIZE,f=n.data[u];n.data[u]=63&f|t,n.dirty=!0}})}}}function GroupPressure(e,t){function r(t,r){e.setPressure(t,r)}t.watch.forward((e,t)=>{const s=new Map;for(let e=0;e<t.length;e++){const r=t[e];0!==r.pressure&&r.regions.forEach(e=>e.groups.forEach(e=>{s.set(e,r.pressure)}))}for(let t=0;t<e.length;t++){const n=e[t];if(0===n.pressure)continue;const o=P(n.pressure);n.regions.forEach(e=>e.groups.forEach(e=>{s.has(e)?o===P(s.get(e))&&s.delete(e):r(e,0)}))}s.forEach((e,t)=>r(t,P(e)))})}function ShuttleGeometry(e){function t(e,t){const r=[],n=new Set3;return e.forEach((o,i,l)=>{if(n.has(o,i,l))return;r.length&&r.push(r[0],r[1],r[0],r[1]);const a=r.length;for(;!n.has(o,i,l);){n.add(o,i,l);const{dx:a,dy:c}=DIRS[l];let h,u,f;e.has(o,i,f=(l+1)%4)?(s(r,o,i,l,t,-1),l=f):e.has(h=o-c,u=i+a,l)?(o=h,i=u):e.has(h=o+a-c,u=i+c+a,f=(l+3)%4)?(s(r,o,i,l,t,1),o=h,i=u,l=f):(s(r,o,i,l,t,1),s(r,o-c,i+a,(l+3)%4,t,1),o+=a,i+=c,l=(l+2)%4)}0!==a&&r.push(r[a],r[a+1])}),r.length?new Float32Array(r):null}const r=new Map;r.default=(e=>{const r=e.points,s=new Set3;r.forEach((e,t,n)=>{if(n&SHUTTLE)for(var o=0;o<4;o++){const{dx:i,dy:l}=DIRS[o];(!shuttleConnects(n,o)||r.get(e+i,t+l)&THINSHUTTLE)&&s.add(e,t,o)}});const n=t(s,.09);return s.clear(),r.forEach((e,t,n)=>{if(n&THINSHUTTLE)for(i=0;i<4;i++)shuttleConnects(n,i)||s.add(e,t,i);else{for(var o=!1,i=0;i<4;i++){const{dx:s,dy:l}=DIRS[i];shuttleConnects(n,i)&&r.get(e+s,t+l)&THINSHUTTLE&&(o=!0)}if(!o)return;for(i=0;i<4;i++){const{dx:o,dy:l}=DIRS[i];(!shuttleConnects(n,i)||r.get(e+o,t+l)&SHUTTLE)&&s.add(e,t,i)}}}),{s:n,ts:t(s,.25)}}),e.deleteWatch.on(e=>r.delete(e));const s=(e,t,r,s,n,o)=>{let i=s===UP||s===RIGHT?t+1:t,l=s===RIGHT||s===DOWN?r+1:r;const{dx:a,dy:c}=DIRS[s];i+=n*(-a-c*o),l+=n*(a*o-c),e.push(i,l)};return{get:e=>r.getDef(e)}}function ShuttleBuffers(e,t,r){const s=new Map,n=t=>{if(!t)return{buffer:null,size:0};const r=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),{buffer:r,size:t.length}};return s.default=(e=>{const t=r.get(e);return{s:n(t.s),ts:n(t.ts)}}),t.deleteWatch.on(t=>{const r=s.get(t);r&&(null!=r.s.buffer&&e.deleteBuffer(r.s.buffer),null!=r.ts.buffer&&e.deleteBuffer(r.ts.buffer))}),{get:e=>s.getDef(e),onContextLost(){s.clear()}}}const{Map2:Map2,Map3:Map3,Set2:Set2,Set3:Set3,Jit:Jit,Watcher:Watcher,util:jitutil}=require("boilerplate-jit"),{DIRS:DIRS}=jitutil,compileProgram=require("./glutil").compileProgram,{lerp:lerp,clamp:clamp,shuttleConnects:shuttleConnects}=require("./util"),glslify=require("glslify"),TILE_SIZE=64,SHUTTLE=64,THINSHUTTLE=128,UP=0,RIGHT=1,DOWN=2,LEFT=3,TEXMAP={};(()=>{const e=["solid","nothing","thinsolid","positive","negative","bridge","ribbon","ribbonbridge"];for(let t=1;t<=16;t++)e.push("ins"+t);e.forEach((e,t)=>{TEXMAP[e]=t})})();const nearestPowerOf2=e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1),TILE_OFFSET_MASK=TILE_SIZE-1,T=e=>Math.floor(e/TILE_SIZE),O=e=>e&TILE_OFFSET_MASK,P=e=>e>0?64:e<0?128:0,SHUTTLE_COLORS={ts:[.847,.529,.972],tshover:[.784,.337,.96],s:[.58,.16,.749],shover:[.501,.035,.682]};module.exports=class{constructor(e,t){this.canvas=e,this.view=t;const r={antialias:!0,depth:!1,stencil:!0},s=this.gl=e.getContext("webgl",r);t.watch.forward(({width:t,height:r})=>{e.width=t*devicePixelRatio,e.height=r*devicePixelRatio,s.viewport(0,0,e.width,e.height)});const n=new Float32Array([0,0,0,1,1,0,1,1]),o=()=>{this.gridShader=compileProgram(s,["proj","tile"],["pos"],{vertex:glslify(["#define GLSLIFY 1\nattribute vec2 pos;\n\nuniform mat3 proj;\n\nvarying vec2 tilexy;\n\nvoid main(void) {\n  tilexy = pos;\n  gl_Position = vec4((vec3(pos, 1) * proj).xy, 0, 1);\n}\n"]),fragment:glslify(['precision mediump float;\n#define GLSLIFY 1\nuniform sampler2D tile;\nvarying vec2 tilexy;\n\n/* I generated the colors from here: http://www.cssportal.com/css-color-converter/\nfunction round(x) { return Math.floor(x * 1000) / 1000; }\nfunction rgb(r, g, b) { console.log("vec4(" + round(r/255) + ", " + round(g/255) + ", " + round(b/255) + ", 1)");}\n */\nvoid main(void) {\n  ivec3 v = ivec3(texture2D(tile, tilexy) * 256.0);\n  int t = v.r;\n  bool neg = (t >= 0x80);\n  if (neg) t -= 0x80;\n\n  bool pos = (t >= 0x40);\n  if (pos) t -= 0x40;\n\n  vec4 color =\n    (t == 0) ? // solid\n      vec4(0.035, 0.098, 0.105, 1) :\n    (t == 1) ? // nothing\n      vec4(1,1,1, 1) :\n    (t == 2) ? // thinsolid\n      vec4(0.709, 0.709, 0.709, 1) :\n    (t == 3) ? // positive\n      vec4(0.36, 0.8, 0.36, 1) :\n    (t == 4) ? // negative\n      vec4(0.839, 0.341, 0.16, 1) :\n    (t == 5) ? // bridge\n      vec4(0.101, 0.494, 0.835, 1) :\n    (t == 6) ? // Ribbon\n      vec4(0.725, 0.235, 0.682, 1) :\n    (t == 7) ? // Ribbonbridge\n      vec4(0.423, 0.117, 0.85, 1)\n    :\n      vec4(1, 0.411, 0.705, 1); // hotpink for anything else.\n\n  gl_FragColor =\n    neg ? color * 0.8 + vec4(0.2, 0, 0, 0.2) :\n    pos ? color * 0.8 + vec4(0, 0.2, 0, 0.2) :\n    color;\n\n  // gl_FragColor = vec4(tilexy.xyx, 1);\n}\n'])}),this.shuttleShader=compileProgram(s,["proj","color"],["pos"],{vertex:glslify(["#define GLSLIFY 1\nattribute vec2 pos;\n\nuniform mat3 proj;\n\nvoid main(void) {\n  gl_Position = vec4((vec3(pos, 1) * proj).xy, 0, 1);\n}\n"]),fragment:glslify(["precision mediump float;\n#define GLSLIFY 1\nuniform vec3 color;\n\nvoid main(void) {\n  // vec4(0.58, 0.16, 0.749, 1);\n  gl_FragColor = vec4(color, 1);\n}\n"])}),this.verts=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.verts),s.bufferData(s.ARRAY_BUFFER,n,s.STATIC_DRAW)};o(),e.addEventListener("webglcontextlost",e=>{console.log("webglcontextlost"),e.preventDefault(),this.tiles&&this.tiles.onContextLost(),this.shuttleBuffers&&this.shuttleBuffers.onContextLost()},!1),e.addEventListener("webglcontextrestored",()=>{console.log("webglcontextrestored"),o(),this.draw()},!1);const i=s.getExtension("WEBGL_lose_context");window.loseContext=(()=>i.loseContext()),window.restoreContext=(()=>i.restoreContext())}addModules(e){const t=e.modules,{baseGrid:r,shuttles:s,engines:n,groups:o,regions:i,zones:l,currentStates:a,stepWatch:c}=t;this.modules=t,this.tiles&&this.tiles.cleanup(),this.frameTimer=t.frameTimer=FrameTimer(a,s,c),this.tiles=t.tiles=Tiles(this.gl,r,o,l,this.frameTimer),this.groupWithPressure=t.groupWithPressure=GroupsWithPressure(r,n,o,i,l,a),this.groupPressure=GroupPressure(this.tiles,this.groupWithPressure),this.shuttleGeometry=t.shuttleGeometry=ShuttleGeometry(s),this.shuttleBuffers=ShuttleBuffers(this.gl,s,this.shuttleGeometry)}setupProjection(e,t,r,s){const n=this.view,o=Math.floor(n.scrollX*n.size),i=Math.floor(n.scrollY*n.size);e[0]=2*t/n.width,e[4]=-2*t/n.height,e[2]=2*(r*t-o)/n.width-1,e[5]=1-2*(s*t-i)/n.height,e[8]=1}drawGrid(){const e=this.gl,t=this.gridShader;e.useProgram(t.program),e.bindBuffer(e.ARRAY_BUFFER,this.verts),e.vertexAttribPointer(t.attrs.pos,2,e.FLOAT,!1,8,0);const r=this.view,s=T(r.scrollX+r.width/r.size),n=T(r.scrollY+r.height/r.size),o=new Float32Array(9);for(let i=T(r.scrollX);i<=s;i++)for(let s=T(r.scrollY);s<=n;s++){const r=this.tiles.data.get(i,s);if(!r)continue;e.activeTexture(e.TEXTURE0),e.uniform1i(t.uniforms.tile,0),r.bind();const n=this.view;this.setupProjection(o,TILE_SIZE*n.size,i,s),e.uniformMatrix3fv(t.uniforms.proj,!1,o),e.drawArrays(e.TRIANGLE_STRIP,0,4)}}drawShuttleGeometry(e,t,r){const s=this.view,n=this.gl,o=new Float32Array(9),i=this.modules.prevState.get(e);var l,a;i&&!e.held?(l=lerp(t,i.dx,e.currentState.dx),a=lerp(t,i.dy,e.currentState.dy)):(l=e.currentState.dx,a=e.currentState.dy);const c=e.bounds,h=s.worldToScreen(c.left+l,c.top+a),u=s.worldToScreen(c.right+l+1,c.bottom+a+1);if(h.px>s.width||h.py>s.height||u.px<0||u.py<0)return!1;const{buffer:f,size:d}=this.shuttleBuffers.get(e)[r];return null!=f&&(this.setupProjection(o,s.size,l,a),n.uniformMatrix3fv(this.shuttleShader.uniforms.proj,!1,o),n.bindBuffer(n.ARRAY_BUFFER,f),n.vertexAttribPointer(this.shuttleShader.attrs.pos,2,n.FLOAT,!1,8,0),n.drawArrays(n.TRIANGLE_FAN,0,d/2),!0)}stencilDance(e){const t=this.gl;t.colorMask(!1,!1,!1,!1),t.stencilOp(t.KEEP,t.KEEP,t.INVERT),t.stencilFunc(t.ALWAYS,0,0),t.stencilMask(1),e(!1),t.colorMask(!0,!0,!0,!0),t.stencilOp(t.KEEP,t.KEEP,t.ZERO),t.stencilFunc(t.EQUAL,1,1),e(!0)}drawShuttles(e,t){var r=0;const s=this.gl,n=this.shuttleShader;s.enable(s.STENCIL_TEST),s.useProgram(n.program);const o=(e,t,r)=>{r("ts",e),r("s",t)};return o(SHUTTLE_COLORS.ts,SHUTTLE_COLORS.s,(o,i)=>{s.uniform3fv(n.uniforms.color,i),this.stencilDance(()=>{this.modules.shuttles.forEach(s=>{s!=t&&this.drawShuttleGeometry(s,e,o)&&r++})})}),t&&(o(SHUTTLE_COLORS.tshover,SHUTTLE_COLORS.shover,(r,o)=>{s.uniform3fv(n.uniforms.color,o),this.stencilDance(()=>this.drawShuttleGeometry(t,e,r))}),r++),s.disable(s.STENCIL_TEST),r}draw(e,t){const r=this.gl;if(!r.isContextLost())return this.groupWithPressure.flush(),r.clear(r.COLOR_BUFFER_BIT),this.drawGrid(),this.drawShuttles(e,t.shuttle)}};

},{"./glutil":8,"./util":9,"boilerplate-jit":13,"glslify":19}],8:[function(require,module,exports){
function compile(r,e,o){const t=r.createShader(e);if(r.shaderSource(t,o),r.compileShader(t),!r.getShaderParameter(t,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(t));return t}exports.compileProgram=function(r,e,o,t){const a=r.createProgram(),n=compile(r,r.VERTEX_SHADER,t.vertex),c=compile(r,r.FRAGMENT_SHADER,t.fragment);if(r.attachShader(a,n),r.attachShader(a,c),r.linkProgram(a),!r.getProgramParameter(a,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(a));r.validateProgram(a);let g=r.getProgramInfoLog(a);g&&console.warn(g);const m={};e&&e.forEach(e=>{m[e]=r.getUniformLocation(a,e)});const i={};return o&&o.forEach(e=>{i[e]=r.getAttribLocation(a,e),r.enableVertexAttribArray(i[e])}),{program:a,uniforms:m,attrs:i,draw(){}}};

},{}],9:[function(require,module,exports){
const letsShuttleThrough=t=>"nothing"===t||"bridge"===t||"ribbon"===t||"ribbonbridge"===t,layerOf=t=>"shuttle"===t||"thinshuttle"===t?"shuttles":"base",lerp=(t,e,h)=>(1-t)*e+t*h,clamp=(t,e,h)=>Math.max(Math.min(t,h),e),shuttleConnects=(t,e)=>t&1<<e;module.exports={letsShuttleThrough:t=>"nothing"===t||"bridge"===t||"ribbon"===t||"ribbonbridge"===t,layerOf:t=>"shuttle"===t||"thinshuttle"===t?"shuttles":"base",lerp:(t,e,h)=>(1-t)*e+t*h,clamp:(t,e,h)=>Math.max(Math.min(t,h),e),shuttleConnects:(t,e)=>t&1<<e};

},{}],10:[function(require,module,exports){
const Watcher=require("boilerplate-jit").Watcher,clamp=require("./util").clamp,UP=0,RIGHT=1,DOWN=2,LEFT=3;module.exports=class{constructor(t,s,i){this.width=t,this.height=s,this.watch=new Watcher(t=>{t(this)}),this.reset(i)}reset(t={}){this.zoomLevel=t.initialZoom||1,this.zoomBy(0),this.scrollX=t.initialX||0,this.scrollY=t.initialY||0,this.watch.signal(this)}fit(t,s,i,l){i-=1,l-=1,t+=2,s+=2,this.scrollX=i,this.scrollY=l;const h=this.width/t,e=this.height/s;let o;h>e?(o=e,this.scrollX-=(this.width/o-t)/2):(o=h,this.scrollY-=(this.height/o-s)/2),this.zoomLevel=o/20,this.zoomBy(0)}zoomBy(t,s){const i=this.size;this.zoomLevel+=t,this.zoomLevel=clamp(this.zoomLevel,.05,5),this.size=20*this.zoomLevel,null!=s&&(this.scrollX+=s.x/i-s.x/this.size,this.scrollY+=s.y/i-s.y/this.size),this.watch.signal(this)}snap(t){const s=Math.floor(this.size);if(this.size!=s){const i=this.size;return this.size=s,null!=t&&(this.scrollX+=t.x/i-t.x/this.size,this.scrollY+=t.y/i-t.y/this.size),!0}return!1}scrollBy(t,s){this.scrollX+=t/this.size,this.scrollY+=s/this.size,this.watch.signal(this)}resizeTo(t,s){this.width=t,this.height=s,this.watch.signal(this)}screenToWorld(t,s){return null==t?{tx:null,ty:null}:(t+=Math.floor(this.scrollX*this.size),s+=Math.floor(this.scrollY*this.size),{tx:Math.floor(t/this.size),ty:Math.floor(s/this.size)})}screenToWorldCell(t,s,i){if(null==t)return{tx:null,ty:null};t+=Math.floor(this.scrollX*this.size),s+=Math.floor(this.scrollY*this.size);const l=t/this.size,h=s/this.size,e=Math.floor(l),o=Math.floor(h),r=i.get("base",e,o);if(!r)return{tx:e,ty:o,tc:null};const c=l-e,a=h-o,n=c>a,z=c+a>1;var u;switch(r){case"bridge":u=n!==z?0:1;break;case"ribbon":case"ribbonbridge":u=Math.floor(a*util.NUMINS);break;case"negative":case"positive":u=n?z?1:0:z?2:3;break;default:u=0}return{tx:e,ty:o,tc:u}}worldToScreen(t,s){return null==t?{px:null,py:null}:{px:t*this.size-Math.floor(this.scrollX*this.size),py:s*this.size-Math.floor(this.scrollY*this.size)}}};

},{"./util":9,"boilerplate-jit":13}],11:[function(require,module,exports){
(function (global){
"use strict";function compare(e,t){if(e===t)return 0;for(var r=e.length,n=t.length,i=0,a=Math.min(r,n);i<a;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0}function isBuffer(e){return global.Buffer&&"function"==typeof global.Buffer.isBuffer?global.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}function pToString(e){return Object.prototype.toString.call(e)}function isView(e){return!isBuffer(e)&&("function"==typeof global.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer))))}function getName(e){if(util.isFunction(e)){if(functionsHaveNames)return e.name;var t=e.toString().match(regex);return t&&t[1]}}function truncate(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function inspect(e){if(functionsHaveNames||!util.isFunction(e))return util.inspect(e);var t=getName(e);return"[Function"+(t?": "+t:"")+"]"}function getMessage(e){return truncate(inspect(e.actual),128)+" "+e.operator+" "+truncate(inspect(e.expected),128)}function fail(e,t,r,n,i){throw new assert.AssertionError({message:r,actual:e,expected:t,operator:n,stackStartFunction:i})}function ok(e,t){e||fail(e,!0,t,"==",assert.ok)}function _deepEqual(e,t,r,n){if(e===t)return!0;if(isBuffer(e)&&isBuffer(t))return 0===compare(e,t);if(util.isDate(e)&&util.isDate(t))return e.getTime()===t.getTime();if(util.isRegExp(e)&&util.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(isView(e)&&isView(t)&&pToString(e)===pToString(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===compare(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(isBuffer(e)!==isBuffer(t))return!1;var i=(n=n||{actual:[],expected:[]}).actual.indexOf(e);return-1!==i&&i===n.expected.indexOf(t)||(n.actual.push(e),n.expected.push(t),objEquiv(e,t,r,n))}return r?e===t:e==t}function isArguments(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function objEquiv(e,t,r,n){if(null===e||void 0===e||null===t||void 0===t)return!1;if(util.isPrimitive(e)||util.isPrimitive(t))return e===t;if(r&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var i=isArguments(e),a=isArguments(t);if(i&&!a||!i&&a)return!1;if(i)return e=pSlice.call(e),t=pSlice.call(t),_deepEqual(e,t,r);var s,o,u=objectKeys(e),f=objectKeys(t);if(u.length!==f.length)return!1;for(u.sort(),f.sort(),o=u.length-1;o>=0;o--)if(u[o]!==f[o])return!1;for(o=u.length-1;o>=0;o--)if(s=u[o],!_deepEqual(e[s],t[s],r,n))return!1;return!0}function notDeepStrictEqual(e,t,r){_deepEqual(e,t,!0)&&fail(e,t,r,"notDeepStrictEqual",notDeepStrictEqual)}function expectedException(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function _tryBlock(e){var t;try{e()}catch(e){t=e}return t}function _throws(e,t,r,n){var i;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof r&&(n=r,r=null),i=_tryBlock(t),n=(r&&r.name?" ("+r.name+").":".")+(n?" "+n:"."),e&&!i&&fail(i,r,"Missing expected exception"+n);var a="string"==typeof n,s=!e&&util.isError(i),o=!e&&i&&!r;if((s&&a&&expectedException(i,r)||o)&&fail(i,r,"Got unwanted exception"+n),e&&i&&r&&!expectedException(i,r)||!e&&i)throw i}var util=require("util/"),hasOwn=Object.prototype.hasOwnProperty,pSlice=Array.prototype.slice,functionsHaveNames="foo"===function(){}.name,assert=module.exports=ok,regex=/\s*function\s+([^\(\s]*)\s*/;assert.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=getMessage(this),this.generatedMessage=!0);var t=e.stackStartFunction||fail;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var r=new Error;if(r.stack){var n=r.stack,i=getName(t),a=n.indexOf("\n"+i);if(a>=0){var s=n.indexOf("\n",a+1);n=n.substring(s+1)}this.stack=n}}},util.inherits(assert.AssertionError,Error),assert.fail=fail,assert.ok=ok,assert.equal=function(e,t,r){e!=t&&fail(e,t,r,"==",assert.equal)},assert.notEqual=function(e,t,r){e==t&&fail(e,t,r,"!=",assert.notEqual)},assert.deepEqual=function(e,t,r){_deepEqual(e,t,!1)||fail(e,t,r,"deepEqual",assert.deepEqual)},assert.deepStrictEqual=function(e,t,r){_deepEqual(e,t,!0)||fail(e,t,r,"deepStrictEqual",assert.deepStrictEqual)},assert.notDeepEqual=function(e,t,r){_deepEqual(e,t,!1)&&fail(e,t,r,"notDeepEqual",assert.notDeepEqual)},assert.notDeepStrictEqual=notDeepStrictEqual,assert.strictEqual=function(e,t,r){e!==t&&fail(e,t,r,"===",assert.strictEqual)},assert.notStrictEqual=function(e,t,r){e===t&&fail(e,t,r,"!==",assert.notStrictEqual)},assert.throws=function(e,t,r){_throws(!0,e,t,r)},assert.doesNotThrow=function(e,t,r){_throws(!1,e,t,r)},assert.ifError=function(e){if(e)throw e};var objectKeys=Object.keys||function(e){var t=[];for(var r in e)hasOwn.call(e,r)&&t.push(r);return t};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"util/":26}],12:[function(require,module,exports){
var Map2,Map3,Set2,Set3,SetOfPairs,assert,inspect,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;inspect=require("util").inspect,assert=require("assert"),exports.Set2=Set2=require("set2"),Map.prototype.getDef=WeakMap.prototype.getDef=function(t){var e;return null==(e=this.get(t))&&(e=this.default(t),this.set(t,e)),e},Set.prototype.map=function(t){var e;return e=new Set,this.forEach(function(r){return e.add(t(r))}),e},exports.Map2=Map2=function(t){function e(t){"function"==typeof t?(this.default=t,e.__super__.constructor.call(this)):e.__super__.constructor.call(this,t)}return extend(e,t),e.prototype.getDef=function(t,e){var r;return null==(r=this.get(t,e))&&this.set(t,e,r=this.default(t,e)),r},e.prototype.forEach=function(t){return e.__super__.forEach.call(this,function(e,r,n){return t(r,n,e)})},e}(require("map2")),exports.Map3=Map3=function(){function t(t){var e,r,n,i,s,o,p;if(this.map=new Map,this.size=0,"function"==typeof t)this.default=t;else if(t)for(e=0,s=t.length;e<s;e++)r=(o=t[e])[0],n=o[1],i=o[2],p=o[3],this.set(r,n,i,p)}return t.prototype.get=function(t,e,r){var n,i,s;return(n=this.map.get(t))&&(i=n.get(e)),i&&(s=i.get(r)),null==s&&this.default&&this.set(t,e,r,s=this.default(t,e)),s},t.prototype.has=function(t,e,r){var n,i;return(n=this.map.get(t))&&(i=n.get(e)),(null!=i?i.has(r):void 0)||!1},t.prototype.set=function(t,e,r,n){var i,s;return(i=this.map.get(t))||(i=new Map,this.map.set(t,i)),(s=i.get(e))||(s=new Map,i.set(e,s)),this.size-=s.size,s.set(r,n),this.size+=s.size,this},t.prototype.delete=function(t,e,r){var n,i,s;return(i=this.map.get(t))&&(s=i.get(e)),!!s&&((n=s.delete(r))&&this.size--,n)},t.prototype.forEach=function(t){return this.map.forEach(function(e,r){return e.forEach(function(e,n){return e.forEach(function(e,i){return t(r,n,i,e)})})})},t.prototype.clear=function(){return this.map.clear()},t.prototype.inspect=function(t,e){var r;return t<0?"[Map3 ("+this.size+")]":0===this.size?"{[Map3]}":(r=[],this.forEach(function(t,n,i,s){return r.push("("+inspect(t,e)+","+inspect(n,e)+","+inspect(i,e)+") : "+inspect(s,e))}),assert(r.length===this.size),"{[Map3] "+r.join(", ")+" }")},t}(),exports.Set3=Set3=function(){function t(t){var e,r,n,i,s,o;if(this.map=new Map,this.size=0,t)for(e=0,r=t.length;e<r;e++)i=(n=t[e])[0],s=n[1],o=n[2],this.add(i,s,o)}return t.prototype.has=function(t,e,r){var n,i;return(n=this.map.get(t))&&(i=n.get(e)),(null!=i?i.has(r):void 0)||!1},t.prototype.add=function(t,e,r){var n,i;return(n=this.map.get(t))||(n=new Map,this.map.set(t,n)),(i=n.get(e))||(i=new Set,n.set(e,i)),this.size-=i.size,i.add(r),this.size+=i.size,this},t.prototype.delete=function(t,e,r){var n,i;return(n=this.map.get(t))&&(i=n.get(e)),!(null==i||!i.delete(r))&&(this.size--,0===i.size&&(n.delete(e),0===n.size&&this.map.delete(t)),!0)},t.prototype.forEach=function(t){return this.map.forEach(function(e,r){return e.forEach(function(e,n){return e.forEach(function(e){return t(r,n,e)})})})},t.prototype.clear=function(){return this.map.clear()},t.prototype.inspect=function(t,e){var r;return t<0?"[Set3 ("+this.size+")]":0===this.size?"{[Set3]}":(r=[],this.forEach(function(t,n,i){return r.push("("+inspect(t,e)+","+inspect(n,e)+","+inspect(i,e)+")")}),assert(r.length===this.size),"{[Set3] "+r.join(", ")+" }")},t}(),exports.SetOfPairs=SetOfPairs=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,Set2),e.prototype.add=function(t,r){return e.__super__.add.call(this,t,r),e.__super__.add.call(this,r,t)},e.prototype.delete=function(t,r){return!!e.__super__.delete.call(this,t,r)&&(e.__super__.delete.call(this,r,t),!0)},e.prototype.getAll=function(t){return this.map.get(t)},e.prototype.deleteAll=function(t){var e;return!!(e=this.map.get(t))&&(e.forEach(function(e){return function(r){var n;if((n=e.map.get(r)).delete(t),0===n.size)return e.map.delete(r)}}(this)),this.map.delete(t),this.size-=2*e.size,!0)},e}();

},{"assert":11,"map2":21,"set2":23,"util":26}],13:[function(require,module,exports){
var collections,i,k,len,ref;for(exports.Jit=require("./jit"),exports.util=require("./util"),exports.Watcher=require("./watch"),collections=require("./collections2"),i=0,len=(ref=["Map2","Set2","Map3","Set3"]).length;i<len;i++)k=ref[i],exports[k]=collections[k];

},{"./collections2":12,"./jit":14,"./util":16,"./watch":17}],14:[function(require,module,exports){
(function (process){
var AwakeShuttles,BaseBuffer,BaseGrid,BlobFiller,CollapseDetector,CurrentStates,DIRS,DOWN,EngineGrid,FillKeys,GroupConnections,Groups,Jit,LEFT,Map2,Map3,RIGHT,Regions,SHUTTLE,Set2,Set3,SetOfPairs,ShuttleBuffer,ShuttleGrid,ShuttleOverlap,ShuttleStates,StateForce,Step,THINSHUTTLE,UP,Watcher,Zones,abs,assert,compareByPosition,filename,fill,letsShuttleThrough,log,makeId,normalizeShuttleV,parseFile,parseXY,pump,ref,ref1,shuttleConnects,util,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};if(Watcher=require("./watch"),ref=require("./collections2"),Map2=ref.Map2,Map3=ref.Map3,Set2=ref.Set2,Set3=ref.Set3,SetOfPairs=ref.SetOfPairs,ref1=util=require("./util"),parseXY=ref1.parseXY,fill=ref1.fill,DIRS=ref1.DIRS,log=require("./log"),assert=require("assert"),UP=0,RIGHT=1,DOWN=2,LEFT=3,makeId=function(){var e;return e=1,function(){return e++}}(),letsShuttleThrough=function(e){return"nothing"===e||"bridge"===e||"ribbon"===e||"ribbonbridge"===e},log.quiet=!0,abs=function(e){return e>=0?e:-e},SHUTTLE=64,THINSHUTTLE=128,normalizeShuttleV=function(e){return"number"==typeof e?e:"shuttle"===e?15|SHUTTLE:"thinshuttle"===e?15|THINSHUTTLE:(assert.equal(e,null),0)},shuttleConnects=function(e,t){return!!(e&1<<t)},compareByPosition=function(e,t){var n,r,u,s;return u=e.anchor.y+e.currentState.dy,n=t.anchor.y+t.currentState.dy,u!==n?u-n:(r=e.anchor.x+e.currentState.dx,s=t.anchor.x+t.currentState.dx,r-s)},BaseGrid=function(){var e,t,n,r;return r=new Map2,n=function(e){return r.forEach(function(t,n,r){return e(t,n,null,r)})},t=new Watcher(n),e=new Watcher(n),{beforeWatch:t,afterWatch:e,get:r.get.bind(r),set:function(n,u,s){var i;return assert(null==s||"string"==typeof s),null!==s&&"solid"!==s||(s=void 0),assert("shuttle"!==s&&"thinshuttle"!==s),i=r.get(n,u),t.signal(n,u,i,s),i=r.get(n,u),s!==i&&(s?r.set(n,u,s):r.delete(n,u),e.signal(n,u,i,s),!0)},forEach:r.forEach.bind(r),checkEmpty:function(){return assert.strictEqual(0,r.size)}}},pump=function(e){return function(t,n){var r;return(r=e.get(t,n))&&e.delete(t,n),r}},BaseBuffer=function(e,t){var n,r;return n=new Map2,r=new Watcher,e.afterWatch.forward(function(e,u,s,i){if(indexOf.call(t,s)>=0&&(assert.equal(n.get(e,u),s),n.delete(e,u),r.signal(e,u)),indexOf.call(t,i)>=0)return n.set(e,u,i),r.signal(e,u,i)}),{watch:r,data:n,pump:pump(n)}},ShuttleBuffer=function(){var e,t;return e=new Map2,t=new Watcher,{set:function(n,r,u){var s,i,a,o,l,c,f,h,d,g,p,S,v,E,m;if(u=normalizeShuttleV(u),t.signal(n,r,u),u){if(e.get(n,r)===u)return;for(i=c=0,h=DIRS.length;c<h;i=++c)o=(p=DIRS[i]).dx,l=p.dy,s=shuttleConnects(u,i),E=n+o,m=r+l,(v=e.get(E,m))?s!==shuttleConnects(v,a=util.oppositeDir(i))&&(s?v|=1<<a:v&=~(1<<a),e.set(E,m,v)):u&=~(1<<i);return e.set(n,r,u)}for(g=e.get(n,r),i=f=0,d=DIRS.length;f<d;i=++f)o=(S=DIRS[i]).dx,l=S.dy,shuttleConnects(g,i)&&(E=n+o,m=r+l,v=e.get(E,m),a=util.oppositeDir(i),assert(shuttleConnects(v,a)),v&=~(1<<a),e.set(E,m,v));return e.delete(n,r)},watch:t,data:e,pump:pump(e)}},BlobFiller=function(e,t){var n,r,u,s,i;if("shuttle"!==e&&"engine"!==e)throw Error("Invalid type");return u=new Set,r=new Watcher(function(e){return u.forEach(e)}),i=new Watcher,s=function(n,r){var s,a;return!!u.delete(n)&&(assert(!r||null!=r.dx),log("Destroyed "+e+" "+n.id+" at",n.points),assert(n.used),n.used=!1,r?(s=r.dx,a=r.dy):s=a=0,n.points.forEach(function(e,n,r){return t.data.set(e+s,n+a,r)}),i.signal(n),!0)},n=function(n,s,i){this.id=makeId(),this.used=!0,this.size=0,this.points=new Map2,this.edges=new Set3,"shuttle"===e&&(this.pushEdges=new Set3,this.numValidStates=0,this.currentState=null,this.eachCurrentPoint=function(e){var t,n;return t=this.currentState?this.currentState.dx:0,n=this.currentState?this.currentState.dy:0,this.points.forEach(function(r,u,s){return e(r+t,u+n,s)})},this.blockedX=this.blockedY=null,this.stepTag=0,this.imX=this.imY=0,this.imXRem=this.imYRem=0,this.zoneDeps=new Set,this.shuttleDeps=new Set),this.anchor={x:n,y:s},u.add(this),util.fill3(n,s,i,function(n){return function(r,u,s,i){var a,o,l,c,f,h,d,g;for(t.pump(r,u),n.size++,n.points.set(r,u,s),(u<n.anchor.y||u===n.anchor.y&&r<n.anchor.x)&&(n.anchor.x=r,n.anchor.y=u),f=[],a=o=0,l=DIRS.length;o<l;a=++o)d=r+(c=DIRS[a]).dx,g=u+c.dy,(h=n.points.get(d,g)||t.data.get(d,g))&&("shuttle"===e&&shuttleConnects(s,a)||"engine"===e&&h===s)?("shuttle"===e&&assert(shuttleConnects(h,util.oppositeDir(a))),i(d,g,h)):n.edges.add(r,u,a),!("shuttle"===e&&s&SHUTTLE)||h&&h&SHUTTLE&&shuttleConnects(s,a)?f.push(void 0):f.push(n.pushEdges.add(r,u,a));return f}}(this)),assert(this.size),"shuttle"===e&&assert(0===this.pushEdges.size||this.pushEdges.size>=4),"engine"===e&&(this.type=i,this.pressure=("positive"===i?1:-1)*this.size),log(this.id,"Added "+e,this),r.signal(this)},{addWatch:r,deleteWatch:i,flush:function(){return t.data.forEach(function(e,t,r){return new n(e,t,r)}),assert.equal(t.data.size,0)},flushAt:function(e,r){var u;if(u=t.data.get(e,r))return new n(e,r,u)},forEach:function(e){return this.flush(),u.forEach(e)},delete:s,check:function(n){return n&&this.forEach(function(){}),u.forEach(function(n){return assert(n.used),n.points.forEach(function(r,u,s){var i,a,o,l,c,f,h,d,g,p;for("engine"===e&&assert(!t.data.has(r,u)),g=[],o=f=0,h=DIRS.length;f<h;o=++f)l=(d=DIRS[o]).dx,c=d.dy,n.points.has(r+l,u+c)?"shuttle"===e?(p=n.points.get(r+l,u+c),i=shuttleConnects(s,o),a=shuttleConnects(p,util.oppositeDir(o)),g.push(assert.equal(i,a,"Mismatched adjacency in a shuttle: "+i+" "+a))):g.push(void 0):"engine"===e?(p=t.data.get(r+l,u+c),g.push(assert(p!==s))):"shuttle"===e?(assert(!shuttleConnects(s,o)),s&SHUTTLE?g.push(assert(n.pushEdges.has(r,u,o))):g.push(void 0)):g.push(void 0);return g})})}}},EngineGrid=function(e,t){var n;return n=new Map2,e.beforeWatch.forward(function(e,r,u,s){var i,a,o,l,c,f,h;if("positive"!==u&&"negative"!==u||!(o=n.get(e,r))||t.delete(o),"positive"===s||"negative"===s){for(h=[],l=0,c=DIRS.length;l<c;l++)i=(f=DIRS[l]).dx,a=f.dy,(o=n.get(e+i,r+a))&&h.push(t.delete(o));return h}}),t.addWatch.forward(function(e){return e.points.forEach(function(t,r,u){return n.set(t,r,e)})}),t.deleteWatch.on(function(e){return e.points.forEach(function(e,t){return n.delete(e,t)})}),{get:function(e,r){return n.get(e,r)||t.flushAt(e,r)},check:function(e){return n.forEach(function(e,t,r){var u,s,i,a,o,l;for(assert(r.used),a=0,o=DIRS.length;a<o;a++)u=(l=DIRS[a]).dx,s=l.dy,(i=n.get(e+u,t+s))&&assert(i===r||r.type!==i.type);return r.points.forEach(function(e,t,u){return assert.equal(n.get(e,t),r)})})}}},ShuttleStates=function(e,t){var n,r,u,s,i;return i=new Map,n=new Watcher(function(e){return i.forEach(function(t,n){return n.forEach(function(t,n,r){return e(r)})})}),s=new Watcher,t.deleteWatch.on(function(e){var t;if(t=i.get(e))return i.delete(e),t.forEach(function(e,t,n){return s.signal(n)})}),r=function(t,n,r){var u;return u=!0,t.points.forEach(function(t,s){if(!letsShuttleThrough(e.get(t+n,s+r)))return u=!1}),u},u=function(e,t,u){var s,a,o;return a=i.get(e),o=r(e,t,u),s={dx:t,dy:u,valid:o,shuttle:e,id:o?e.numValidStates:-1,stepTag:0},o&&e.numValidStates++,a?a.set(t,u,s):i.set(e,new Map2([[t,u,s]])),o&&log("made shuttle state for shuttle",s.id,s.shuttle.id,s.dx,s.dy),n.signal(s),s},{flushStatesAt:function(e,n){return t.flushAt(e,n)},addWatch:n,deleteWatch:s,get:function(e){return i.get(e)},getInitialState:function(e){var t;return(null!=(t=this.get(e))?t.get(0,0):void 0)||u(e,0,0)},collapse:function(e){var t,n;if(log("collapsing",e),t=e.currentState,n=i.get(e))return n.forEach(function(e,r,u){if(u!==t)return n.delete(e,r),s.signal(u)})},getStateNear:function(e,t){var n,r,s,a;return assert(e.shuttle.used),e.valid?(s=DIRS[t],n=s.dx,r=s.dy,n+=e.dx,r+=e.dy,null==(a=i.get(e.shuttle).get(n,r))&&(a=u(e.shuttle,n,r)),a.valid?a:void 0):null},delete:function(e){var t;return log("deleting state",e),t=e.shuttle,assert(t.used),i.get(t).delete(e.dx,e.dy),s.signal(e)}}},ShuttleGrid=function(e){var t,n,r,u;return t=new Map2(function(){return new Set}),n=new Watcher,r=new Map2(function(){return new Set}),u=new Watcher,e.addWatch.forward(function(e){return e.shuttle.points.forEach(function(s,i,a){if(s+=e.dx,i+=e.dy,r.getDef(s,i).add(e),u.signal(s,i),a&SHUTTLE&&e.valid)return t.getDef(s,i).add(e),n.signal(s,i)})}),e.deleteWatch.on(function(e){return log("shuttle grid removing",e.shuttle.id,e.dx,e.dy),e.shuttle.points.forEach(function(s,i,a){if(s+=e.dx,i+=e.dy,r.get(s,i).delete(e),u.signal(s,i),a&SHUTTLE&&e.valid)return t.get(s,i).delete(e),n.signal(s,i)})}),{fillGrid:t,fillWatch:n,stateGrid:r,stateWatch:u,getStates:function(e,t){return r.get(e,t)},getShuttle:function(e,t){var n,u;return u=null,null!=(n=r.get(e,t))&&n.forEach(function(e){if(e.shuttle.currentState===e)return u=e.shuttle}),u},getValue:function(e,t){var n,r,u,s;if(s=this.getShuttle(e,t))return u=s.currentState,n=u.dx,r=u.dy,s.points.get(e-n,t-r)},check:function(){}}},FillKeys=function(e,t,n){var r,u,s,i,a;return u=new Map2,s=new Map,s.default=function(){return new Set},s.set("",new Set),i=new WeakMap,i.default=function(){return new Set},a=new Watcher,n.fillWatch.on(function(e,t){return u.delete(e,t)}),e.afterWatch.on(function(e,t,n,r){if(letsShuttleThrough(n))return u.delete(e,t)}),t.deleteWatch.on(function(e){var t;return null!=(t=i.get(e))?t.forEach(function(e){return s.delete(e),a.signal(e)}):void 0}),r=function(e,t){var r,u,a,o,l,c,f,h,d;if(d=[],null!=(c=n.fillGrid.get(e,t))&&c.forEach(function(e){return d.push(e)}),d.sort(function(e,t){return e.shuttle!==t.shuttle?e.shuttle.id-t.shuttle.id:e.id-t.id}),u=d.map(function(e){return e.shuttle.id+"."+e.id}).join(" "),!s.has(u))for(f=s.getDef(u),r=0,o=d.length;r<o;r++)h=d[r],f.add(h);for(a=0,l=d.length;a<l;a++)h=d[a],i.getDef(h).add(u);return u},{watch:a,getFilledStates:function(e){return s.get(e)},getFillKey:function(n,s){var i;return letsShuttleThrough(e.get(n,s))?(t.flushStatesAt(n,s),(i=u.get(n,s))||(i=r(n,s),u.set(n,s,i)),i):""},checkEmpty:function(){return assert.equal(0,u.size),assert.equal(1,s.size)}}},Groups=function(e,t,n,r,u){var s,i,a,o,l,c,f,h,d,g;return g=new Set3,f=new Set,c=new Map3,l=new Map2(function(){return new Set}),s=new Watcher(f),o=new Watcher,h=new WeakMap,h.default=function(){return new Set},a=function(t,n){var r,u,s,a,o;for(o=[],r=s=0,a=util.cellMax(e.get(t,n));0<=a?s<a:s>a;r=0<=a?++s:--s)(u=c.get(t,n,r))?o.push(i(u)):o.push(void 0);return o},i=function(e){return log(e._id,": deleting group",e._id),assert(e.used),e.used=!1,f.delete(e),e.engines.forEach(function(t){return h.get(t).delete(e)}),e.points.forEach(function(e,t,n,r){return g.add(e,t,n),c.delete(e,t,n)}),e.edges.forEach(function(t,n,r){return l.get(t,n).delete(e)}),o.signal(e)},e.afterWatch.forward(function(e,t,n,r){var u,s,o,l,f,h,d,p,S,v,E,m;for(u=f=0,S=util.cellMax(n);0<=S?f<S:f>S;u=0<=S?++f:--f)(l=c.get(e,t,u))&&i(l),g.delete(e,t,u);for(h=0,d=DIRS.length;h<d;h++)s=(v=DIRS[h]).dx,o=v.dy,a(e+s,t+o);for(m=[],u=p=0,E=util.cellMax(r);0<=E?p<E:p>E;u=0<=E?++p:--p)m.push(g.add(e,t,u));return m}),t.deleteWatch.on(function(e){var t;if(t=h.get(e))return t.forEach(function(e){return i(e)}),h.delete(e)}),r.fillWatch.on(function(e,t){var n;return a(e,t),null!=(n=l.get(e,t))?n.forEach(function(e){return i(e)}):void 0}),d=function(t,r,i){var a,o,d,p,S;return S=e.get(t,r),assert(null!=S),assert(i<util.cellMax(S)),assert(g.has(t,r,i)),d=u.getFillKey(t,r),a=u.getFilledStates(d),p=util.uniqueShuttlesInStates(a),o={_id:makeId(),used:!0,size:0,fillKey:d,points:new Map3,edges:new Set3,shuttles:p,shuttleKey:p.map(function(e){return""+e.id}).join(" "),useless:!0,engines:new Set},log(o._id,": makeGroupAt",t,r,i,"'"+d+"'"),util.fill3(t,r,i,function(t,r,s,i){var a,f,p,S,v,E;if(E=e.get(t,r)){if(E&&"positive"!==E&&"negative"!==E&&(o.useless=!1),u.getFillKey(t,r)!==d)return o.edges.add(t,r,s),void l.getDef(t,r).add(o);for(log("fillCells",t,r,s,E),o.points.set(t,r,s,E),o.size++,assert(!c.has(t,r,s)),c.set(t,r,s,o),assert(g.has(t,r,s)),g.delete(t,r,s),"positive"!==E&&"negative"!==E||(a=n.get(t,r),o.engines.add(a),h.getDef(a).add(o)),f=0,p=(S=util.connectedCells(e,t,r,s)).length;f<p;f++)i((v=S[f])[0],v[1],v[2])}}),f.add(o),o.useless||log(o._id,": made group",o.points),assert(o.size),assert(o.used),s.signal(o),o},{addWatch:s,deleteWatch:o,get:function(t,n,r){var u,s;if((u=c.get(t,n,r))||(s=e.get(t,n),assert(0<=r&&r<util.cellMax(s)),null!=s&&(u=d(t,n,r))),!u.useless)return u},getDir:function(t,n,r){var u,s;if((s=e.get(t,n))&&"ribbon"!==s&&"ribbonbridge"!==s)return u=function(){switch(s){case"positive":case"negative":return r;case"bridge":return r%2;default:return 0}}(),this.get(t,n,u)},flush:function(){return g.forEach(function(e,t,n){return d(e,t,n)})},forEach:function(e){return this.flush(),f.forEach(function(t){if(!t.useless)return e(t)})},check:function(){return f.forEach(function(e){return e.points.forEach(function(t,n,r){return assert.equal(c.get(t,n,r),e)})})},checkEmpty:function(){return assert.equal(0,f.size),assert.equal(0,c.size),assert.equal(0,g.size)}}},StateForce=function(e,t,n,r){var u,s,i,a,o;return a=new Map,a.default=function(e){return s(e)},i=new Map,i.default=function(){return new Set},o=new Watcher,t.deleteWatch.on(function(e){var n,r,s,i,a,o,l,c;if(u(e),c=t.get(e.shuttle)){for(o=[],s=0,i=DIRS.length;s<i;s++)n=(a=DIRS[s]).dx,r=a.dy,(l=c.get(e.dx+n,e.dy+r))?o.push(u(l)):o.push(void 0);return o}}),e.afterWatch.on(function(e,t,r,s){var i,a,o,l,c,f,h;if(0===util.cellMax(r)){for(f=[],o=0,l=DIRS.length;o<l;o++)i=(c=DIRS[o]).dx,a=c.dy,h=n.getStates(e+i,t+a),f.push(null!=h?h.forEach(u):void 0);return f}}),r.deleteWatch.on(function(e){var t;if(log("got group deleted",e._id),t=i.get(e))return t.forEach(function(e){return u(e)}),assert(!i.has(e))}),u=function(e){var t,n,r,u;if(n=a.get(e))return a.delete(e),log("deleteForce",e.shuttle.id,e.dx,e.dy),n.used=!1,t=function(t,n){var r;if((r=i.get(n))&&(r.delete(e),0===r.size))return i.delete(n)},null!=(r=n.x)&&r.forEach(t),null!=(u=n.y)&&u.forEach(t),o.signal(e,n)},s=function(e){var n,u,s,a,o,l,c,f,h;for(log("makeForce",e.shuttle.id,e.dx,e.dy),assert(e.shuttle.used),assert(e.valid),n=t.getStateNear(e,LEFT)||t.getStateNear(e,RIGHT),u=t.getStateNear(e,UP)||t.getStateNear(e,DOWN),null!=(c=(s={x:n?new Map:void 0,y:u?new Map:void 0,used:!0}).x)&&(c.default=function(){return 0}),null!=(f=s.y)&&(f.default=function(){return 0}),(n||u)&&e.shuttle.pushEdges.forEach(function(t,i,a){var o,l,c,f,h,d;if(t+=e.dx,i+=e.dy,a===LEFT||a===RIGHT){if(!n)return;h=s.x,c=a===LEFT?-1:1}else{if(!u)return;h=s.y,c=a===UP?-1:1}if(d=DIRS[a],o=d.dx,l=d.dy,log("edge",t,i),log("looking in",t+o,i+l,util.oppositeDir(a)),f=r.getDir(t+o,i+l,util.oppositeDir(a)))return h.set(f,h.getDef(f)+c)}),a=0,o=(h=[s.x,s.y]).length;a<o;a++)(l=h[a])&&l.forEach(function(t,n){return 0===t?l.delete(n):i.getDef(n).add(e)});return s},{watch:o,get:function(e){var t;return t=a.getDef(e),assert(t.used),t}}},GroupConnections=function(e){var t,n,r;return n=new SetOfPairs,t=new WeakSet,e.deleteWatch.on(function(e){var r;return(r=n.getAll(e))&&r.forEach(function(e){return t.delete(e)}),n.deleteAll(e)}),r=function(r){return assert(r.used),r.edges.forEach(function(t,u,s){var i;return i=e.get(t,u,s),assert(i.used),n.add(r,i)}),t.add(r)},{get:function(e){return t.has(e)||r(e),n.getAll(e)},check:function(r){return r&&e.forEach(function(e){return function(t){var n;return n=e.get(t),assert(n)}}(this)),n.forEach(function(e,n){var u;if(r&&(assert(t.has(e)),assert(t.has(n))),t.has(e))return assert(e.used),assert(n.used),u=!1,e.edges.forEach(function(e,t,r){if(n.points.has(e,t,r))return u=!0}),assert(u)})},checkEmpty:function(){return assert.equal(0,n.size)}}},Regions=function(e,t,n){var r,u,s,i,a,o,l;return a=new Map,a.default=function(e){return new util.ShuttleStateMap(e.shuttles)},o=new Map,o.default=function(){return new Set},i=new Set,l=new Watcher,t.deleteWatch.on(function(e){var t,n;if(t=a.get(e))return a.delete(e),t.forEachValue(function(e){return u(e)}),(n=o.get(e))?(n.forEach(function(e){return u(e)}),o.delete(e)):void 0}),u=function(e){return log("delete region",e._id),assert(e.used),e.used=!1,i.delete(e),e.groups.forEach(function(t){var n;return null!=(n=a.get(t))?n.delete(e.states):void 0}),e.edges.forEach(function(t){var n;if((n=o.get(t))&&(n.delete(e),0===n.size))return o.delete(t)}),l.signal(e)},r=function(t,r,u){var s;assert(a.getDef(t).isDefinedFor(u)),s=t.shuttleKey,this._id=makeId(),this.used=!0,this.size=0,this.groups=new Set,this.states=r,this.edges=new Set,this.engines=new Set,log(this._id,": createRegion from group",t._id),util.fillGraph(t,function(t){return function(u,i){var l,c,f;return u.shuttleKey!==s?(t.edges.add(u),void o.getDef(u).add(t)):(c=e.getFilledStates(u.fillKey),l=!1,r.forEach(function(e){if(c.has(e))return l=!0}),l?void 0:(a.getDef(u).set(r,t),t.size++,t.groups.add(u),u.engines.forEach(function(e){return t.engines.add(e)}),null!=(f=n.get(u))?f.forEach(i):void 0))}}(this)),assert(this.size),i.add(this),log(this._id,": Made region with groups",this.groups.map(function(e){return{id:e._id,points:e.points}}))},s=function(t,n){var u,s,i;return i=new Map,s=!1,u=e.getFilledStates(t.fillKey),t.shuttles.forEach(function(e){var t;if(t=n.get(e),i.set(e,t),u.has(t))return s=!0}),s?(a.getDef(t).set(n,null),null):new r(t,i,n)},{watch:l,get:function(e,t){var n,r;return n=a.getDef(e),void 0===(r=n.get(t))&&(r=s(e,t)),null===r?null:r},check:function(){return i.forEach(function(e){return assert(e.used),assert(e.size),e.groups.forEach(function(e){return assert(e.used)})})},checkEmpty:function(){return assert.equal(0,a.size),assert.equal(0,o.size),assert.equal(0,i.size)}}},CurrentStates=function(e,t,n){var r,u;return r=new Map,u=new Watcher,e.addWatch.forward(function(e){var t;return t=n.getInitialState(e),e.currentState=t,r.set(e,t),u.signal(e,null,t)}),e.deleteWatch.on(function(e){return r.delete(e),e.currentState=null}),function(e){},{map:r,watch:u,set:function(e,t){var n;if(assert.strictEqual(t.shuttle,e),e.currentState!==t)return log("moving "+e.id+" to "+t.dx+","+t.dy),n=e.currentState,e.currentState=t,r.set(e,t),u.signal(e,n,t)}}},CollapseDetector=function(e,t,n,r,u){return e.beforeWatch.forward(function(e,t,s,i){var a,o,l,c;return o=letsShuttleThrough(s),a=letsShuttleThrough(i),!o&&a?null!=(l=u.stateGrid.get(e,t))?l.forEach(function(e){if(!e.valid)return r.delete(e)}):void 0:o&&!a&&null!=(c=u.stateGrid.get(e,t))?c.forEach(function(e){var t;return(t=e.shuttle).currentState===e?n.delete(t,e):r.collapse(t)}):void 0}),t.watch.on(function(e,t,r){var s,i,a,o,l,c,f,h;for((h=u.getShuttle(e,t))&&n.delete(h,h.currentState),f=[],s=o=0,l=DIRS.length;o<l;s=++o)i=(c=DIRS[s]).dx,a=c.dy,shuttleConnects(r,s)&&((h=u.getShuttle(e+i,t+a))?f.push(n.delete(h,h.currentState)):f.push(void 0));return f})},Zones=function(e,t,n){var r,u,s,i,a,o,l,c;return l=new Map,c=new Map,c.default=function(){return new Set},o=new Watcher,u=!1,r=[],t.watch.on(function(e){return s(l.get(e)),l.delete(e)}),i=function(e){var t;return log("deleteZonesWithShuttle",e.id),null!=(t=c.get(e))&&t.forEach(function(e){return s(e)}),c.delete(e)},e.deleteWatch.on(i),n.watch.on(i),s=function(e){if(null!=e?e.used:void 0)return log("deleting zone",e._id),e.used=!1,u?r.push(e):o.signal(e)},a=function(e){var r,u;return u={_id:makeId(),used:!0,pressure:0,fixed:!0,filled:!1},log(u._id,": makezone from",null!=e?e._id:void 0),r=new Set,e&&util.fillGraph(e,function(e,s){var i;return log("zone fillGraph",e._id),assert(!(null!=(i=l.get(e))?i.used:void 0)),l.set(e,u),e.states.size&&(u.fixed=!1),e.states.forEach(function(e){return c.getDef(e.shuttle).add(u)}),e.engines.forEach(function(e){if(!r.has(e))return assert(e.used),r.add(e),u.pressure+=e.pressure}),e.edges.forEach(function(r){var i,a,o,l;if(assert(r.used),null===(e=t.get(r,n.map)))for(i=0,a=(o=r.shuttles).length;i<a;i++)l=o[i],c.getDef(l).add(u);if(e)return s(e)})}),u},{startBuffer:function(){return u=!0},flushBuffer:function(){var e,t,n;for(e=0,t=r.length;e<t;e++)n=r[e],o.signal(n);return r.length=0,u=!1},watch:o,makeZoneUnderShuttle:function(e){var t;return t=a(null),c.getDef(e).add(t),t.filled=!0,t},getZoneForRegion:function(e){var t;return assert(e),(null!=(t=l.get(e))?t.used:void 0)||(t=a(e)),t},getZoneForGroup:function(e){var r;return(r=t.get(e,n.map))?this.getZoneForRegion(r):null},checkEmpty:function(){return assert.strictEqual(0,l.size)}}},AwakeShuttles=function(e,t,n,r,u){var s,i,a,o;return s=new Set,a=new Map,a.default=function(){return new Set},e.deleteWatch.on(function(e){return log("s deletewatch",e),o(e),s.delete(e)}),u.watch.on(function(e){var t;if(log("zw",e._id,e),t=a.get(e))return log("zones watch",e._id),t.forEach(function(e){return o(e,"adjacent zone killed")}),a.delete(e)}),n.watch.on(function(e){if(e.shuttle.currentState===e)return o(e.shuttle,"force recalculated")}),r.watch.on(function(e){return o(e,"shuttle state changed")}),t.deleteWatch.on(function(e){return log("state deletewatch",e),o(e.shuttle,"state was deleted")}),i=function(e){return(u=e.zoneDeps).forEach(function(t){var n;return null!=(n=a.get(t))?n.delete(e):void 0}),u.clear(),e.shuttleDeps.forEach(function(t){return t.shuttleDeps.delete(e)}),e.shuttleDeps.clear()},o=function(e,t){if(!s.has(e))return log("waking "+e.id+" because "+t),s.add(e),e.shuttleDeps.forEach(function(e){return log("-> depends on",e.id),o(e,"shuttle dependancy moved")}),i(e);t&&log("redundant wake",e.id,t)},{data:s,sleep:function(e){var t;if(s.has(e))return s.delete(e),u=e.zoneDeps,t=!0,u.forEach(function(e){if(!e.used)return t=!1}),u.forEach(function(t){return a.getDef(t).add(e)}),log("setAsleepDeps",e.id)},forEach:function(t){return e.flush(),s.forEach(t)},isAwake:function(e){return s.has(e)},check:function(){return s.forEach(function(e){return assert.strictEqual(e.zoneDeps.size,0),assert.strictEqual(e.shuttleDeps.size,0)}),a.forEach(function(e,t){return assert(t.used),e.forEach(function(e){return assert(e.used),assert(!s.has(e)),assert(e.zoneDeps.has(t))})}),e.forEach(function(e){return e.zoneDeps.forEach(function(t){return assert(a.get(t).has(e))}),e.shuttleDeps.forEach(function(t){return assert(t.shuttleDeps.has(e))})})},checkEmpty:function(){return assert.strictEqual(s.size,0)},stats:function(){return console.log("shuttlesForZone.size:",a.size)}}},ShuttleOverlap=function(e,t){var n;return n=new SetOfPairs,e.addWatch.forward(function(e){if(e.valid)return e.shuttle.points.forEach(function(r,u){var s;return null!=(s=t.stateGrid.get(r+e.dx,u+e.dy))?s.forEach(function(t){if(t.shuttle!==e.shuttle)return n.add(e,t)}):void 0})}),e.deleteWatch.on(function(e){return n.deleteAll(e)}),{forEach:function(e,t){var r;return null!=(r=n.getAll(e))?r.forEach(function(e){return t(e,e.shuttle)}):void 0},willOverlap:function(e){var t;return t=!1,this.forEach(e,function(e,n){if(n.currentState===e)return t=!0}),t}}},Step=function(e){var t,n,r,u,s,i,a,o,l,c,f,h;return h=e.zones,e.shuttles,t=e.awakeShuttles,i=e.shuttleStates,l=e.stateForce,r=e.currentStates,s=e.shuttleOverlap,u=e.fillKeys,c=0,a=[],o=[],n=function(e,t){var n;return t?(n=0,t.forEach(function(t,r){var s,i,a;return assert(r.used),(a=h.getZoneForGroup(r))?(assert(a.used),a.pressure&&log("pressure",a.pressure),n-=t*a.pressure):(i=u.getFilledStates(r.fillKey),s=null,r.shuttles.forEach(function(e){if(i.has(e.currentState))return assert.equal(s,null),s=e}),assert(s),a=h.makeZoneUnderShuttle(s)),e.zoneDeps.add(a)}),n):0},f=function(e,n){var u,a,o,l,f,h,d,g,p,S,v,E,m,w,y,D,W,k,x,R,b,z;if(y=n?c:-c,e.stepTag===-y)return!1;if(v=!1,!(l=n?e.imYRem:e.imXRem))return!1;for(E=1,a=l<0?(l=-l,E=-1,n?UP:LEFT):n?DOWN:RIGHT,log("tryMove shuttle",e.id,util.DN[a],l),b=[e],w=!1,(R=new Set).add(e);l;){for(assert(l>0),u=!1,W=0,o=0;o<b.length;){if(k=b[o],!(D=i.getStateNear(k.currentState,a))){log("shuttle hit wall in dir",util.DN[a],"from state",k.currentState.dx,k.currentState.dy),u=!0,k!==e&&(e.shuttleDeps.add(k),k.shuttleDeps.add(e));break}s.forEach(D,function(e,t){var r;if(e.stepTag===-y)return log("Blocked by shadow"),u=!0;if(t.currentState===e)return t.stepTag===-y?(log("blocked by shuttle"),u=!0):!R.has(t)&&(R.add(t),b.push(t),w=!0,(r=-E*(n?t.imYRem:t.imXRem))>0)?W+=r:void 0}),o++}if(u)break;if(W>l)for(log("Opposing force too great",W,l),w&&b.sort(compareByPosition),w=!1,h=0,g=b.length;h<g&&!((x=b[h])!==e&&(f=-E*(n?x.imYRem:x.imXRem))>0&&(z=Math.min(l,f),assert(z>0),assert(t.isAwake(x)),e.shuttleDeps.add(x),x.shuttleDeps.add(e),f-=z,l-=z,n?x.imYRem=-f*E:x.imXRem=-f*E,0===l));h++);else if(W>0)for(log("Crushing resistance force of",W),l-=W,d=0,p=b.length;d<p;d++)(x=b[d])!==e&&(f=-E*(n?x.imYRem:x.imXRem))>0&&(assert(t.isAwake(x)),e.shuttleDeps.add(x),x.shuttleDeps.add(e),n?x.imYRem=0:x.imXRem=0);if(0===l)break;for(assert(l>0),l--,m=0,S=b.length;m<S;m++)x=b[m],D=i.getStateNear(x.currentState,a),assert(D),x.stepTag=y,x.currentState.stepTag=y,log("Moving shuttle",x.id,"to state",D.dx,D.dy),r.set(x,D),v=!0,n?x.imXRem=0:x.imYRem=0,(f=E*(n?x.imYRem:x.imXRem))>0&&(f--,n?x.imYRem=f*E:x.imXRem=f*E);v=!0}return n?e.imYRem=l*E:e.imXRem=l*E,log("tryMove ->",v),v},function(){var e,r,u,s,i,d,g,p,S,v,E,m;for(log("************** STEP "+ ++c+" **************"),log("** phase 1) calculating pressure ***"),h.startBuffer(),t.forEach(function(e){var t,r,u,s;if(assert.equal(e.zoneDeps.size,0),assert.equal(e.shuttleDeps.size,0),log("step() looking at shuttle",e.id),Jit.stats.checks++,!e.held)return assert(e.used),t=l.get(e.currentState),r=t.x,u=t.y,(s=n(e,r))&&(e.imXRem=e.imX=s,a.push(e)),(s=n(e,u))&&(e.imYRem=e.imY=s,o.push(e)),log("impulse",e.imX,e.imY)}),a.sort(function(e,t){return abs(t.imX)-abs(e.imX)||compareByPosition(e,t)}),o.sort(function(e,t){return abs(t.imY)-abs(e.imY)||compareByPosition(e,t)}),log("***** phase 2) moving shuttles *****"),log("Shuttles to move: ",a.map(function(e){return e.id}),o.map(function(e){return e.id})),g=0,e=r=0;;){if(e===a.length){for(u=0,i=(p=o.slice(r)).length;u<i;u++)v=p[u],g+=f(v,!0);break}if(r===o.length){for(s=0,d=(S=a.slice(e)).length;s<d;s++)v=S[s],g+=f(v,!1);break}abs((E=a[e]).imX)>abs((m=o[r]).imY)?(e++,g+=f(E,!1)):(r++,g+=f(m,!0))}return log("**** phase 3) cleanup ****"),t.forEach(function(e){return abs(e.stepTag)===c||e.held?(Jit.stats.moves++,log("shuttle",e.id,"still awake - ",e.stepTag),e.zoneDeps.clear(),e.shuttleDeps.forEach(function(t){return t.shuttleDeps.delete(e)}),e.shuttleDeps.clear()):(log("sleeping shuttle",e.id,Array.from(e.zoneDeps).map(function(e){return e._id})),t.sleep(e))}),h.flushBuffer(),log("moved",g),a.length=o.length=0,!!g}},module.exports=Jit=function(e){var t,n,r,u,s,i,a,o,l,c,f,h,d,g,p,S,v,E,m,w,y;return n=BaseGrid(),u=BaseBuffer(n,["positive","negative"]),i=BlobFiller("engine",u),s=EngineGrid(n,i),g=ShuttleBuffer(),E=BlobFiller("shuttle",g),v=ShuttleStates(n,E),p=ShuttleGrid(v),CollapseDetector(n,g,E,v,p),a=FillKeys(n,v,p),l=Groups(n,i,s,p,a),m=StateForce(n,v,p,l),r=CurrentStates(E,m,v),o=GroupConnections(l),f=Regions(a,l,o),y=Zones(E,f,r),S=ShuttleOverlap(v,p,r),t=AwakeShuttles(E,v,m,r,y),c={baseGrid:n,engineBuffer:u,engines:i,engineGrid:s,shuttleBuffer:g,shuttles:E,shuttleStates:v,shuttleGrid:p,fillKeys:a,groups:l,stateForce:m,groupConnections:o,regions:f,currentStates:r,zones:y,awakeShuttles:t,shuttleOverlap:S},w=Step(c),h=function(e,t,r,u){return n.set(e,t,r),g.set(e,t,u)},d=function(e){return util.deserialize(e,!1,h)},e&&d(e),{baseGrid:n,modules:c,getZoneContents:function(e,t,n){var r,u,s;return(r=c.groups.get(e,t,n))?(u=new Set2,i=new Set,(s=c.regions.get(r,c.currentStates.map))&&util.fillGraph(s,function(e,t){return e.groups.forEach(function(e){return e.points.forEach(function(e,t,n,r){return u.add(e,t)})}),e.engines.forEach(function(e){return i.add(e)}),e.edges.forEach(function(n){if(assert(n.used),e=c.regions.get(n,c.currentStates.map))return t(e)})}),{points:u,engines:i}):null},moveShuttle:function(e,t){var n;if(n=!1,S.forEach(t,function(e,t){if(t.currentState===e)return n=!0}),!n)return r.set(e,t)},step:function(){return w()},check:function(e){var t,r;for(t in c)"function"==typeof(r=c[t]).check&&r.check(e);return E.forEach(function(e){return e.eachCurrentPoint(function(e,t,r){var u;return u=n.get(e,t),assert("nothing"===u||"bridge"===u||"ribbon"===u||"ribbonbridge"===u)})})},checkEmpty:function(){var e,t,n;n=[];for(e in c)t=c[e],n.push("function"==typeof t.checkEmpty?t.checkEmpty():void 0);return n},printGrid:function(e){var t,r;return null==e&&(e=process.stdout),r=new Map2,t=new Map2,E.forEach(function(e){var n,u,s;return(s=e.currentState)?(n=s.dx,u=s.dy,e.points.forEach(function(s,i,a){return r.set(s+n,i+u,a&SHUTTLE?"shuttle":"thinshuttle"),t.set(s+n,i+u,e.id)})):log("no state for",e)}),util.printCustomGrid(util.gridExtents(n),function(e,t){return r.get(e,t)||n.get(e,t)},t.get.bind(t),e)},toJSON:function(){var e;return e={base:{},shuttles:{}},n.forEach(function(t,n,r){if(assert("string"==typeof r),null!=r)return e.base[t+","+n]=r}),E.forEach(function(t){var n,r,u;return u=t.currentState,n=u.dx,r=u.dy,t.points.forEach(function(t,u,s){return e.shuttles[t+n+","+(u+r)]=s})}),e},set:h,get:function(e,t,r){switch(e){case"shuttles":return g.data.get(t,r)||p.getValue(t,r);case"base":return n.get(t,r);default:throw Error("No such layer "+e)}},stats:function(){var e,t;console.log(Jit.stats);for(e in c)"function"==typeof(t=c[e]).stats&&t.stats()},setQuiet:function(e){return null==e&&(e=!1),log.quiet=e}}},Jit.stats={moves:0,checks:0},parseFile=exports.parseFile=function(e,t){var n,r,u,s,i,a,o,l;for(r=require("fs"),delete(n=JSON.parse(r.readFileSync(e,"utf8").split("\n")[0])).tw,delete n.th,(i=new Jit(n,t)).modules.shuttles.forEach(function(e){return console.log("Shuttle "+e.id+" has points",e.points)}),i.printGrid(),l=u=1;u<=10;l=++u)if(o=i.step(),console.log("Post step",l),i.printGrid(),console.log("# Awake shuttles:",Array.from(i.modules.awakeShuttles.data).map(function(e){return e.id})),console.log(),!o){log.quiet=!0,a=i.toJSON(),s=new Jit(a),assert(!s.step(),"World erroneously stable"),console.log("-> World stable.");break}return log("-----")},require.main===module){if(!(filename=process.argv[2]))throw Error("Missing file argument");log.quiet="-v"!==process.argv[3],parseFile(filename),console.log(Jit.stats),console.log("("+Math.floor(100*Jit.stats.moves/Jit.stats.checks)+"% efficiency)")}

}).call(this,require('_process'))
},{"./collections2":12,"./log":15,"./util":16,"./watch":17,"_process":22,"assert":11,"fs":18}],15:[function(require,module,exports){
(function (process){
var log,slice=[].slice;(log=module.exports="production"===process.env.NODE_ENV?function(){}:function(){var o,e,l;if(o=1<=arguments.length?slice.call(arguments,0):[],!log.quiet)return"object"==typeof window?console.log.apply(console,o):(l=require("util").inspect,e=function(o){return"string"==typeof o?o:l(o,{depth:5,colors:!0})},console.log(o.map(e).join(" ")))}).quiet=!1;

}).call(this,require('_process'))
},{"_process":22,"util":26}],16:[function(require,module,exports){
(function (process){
var DIRS,DN,DOWN,LEFT,Map2,Map3,NUMINS,RIGHT,SHUTTLE,Set2,Set3,ShuttleStateMap,THINSHUTTLE,UP,assert,cellAt,chalk,chars,connectedCells,deserialize,insLevelOf,insNum,jsonExtents,log,oppositeDir,parseXY,printCustomGrid,ref,shuttleStr;ref=require("./collections2"),Map2=ref.Map2,Set2=ref.Set2,Map3=ref.Map3,Set3=ref.Set3,log=require("./log"),assert=require("assert"),UP=0,RIGHT=1,DOWN=2,LEFT=3,DN=exports.DN={0:"UP",1:"RIGHT",2:"DOWN",3:"LEFT"},DIRS=exports.DIRS=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0}],NUMINS=exports.NUMINS=16,insNum=exports.insNum=function(){var t,e,r;for(r={},t=e=1;e<=16;t=++e)r["ins"+t]=t-1;return function(t){var e;return null!=(e=r[t])?e:-1}}(),SHUTTLE=64,THINSHUTTLE=128,shuttleStr=exports.shuttleStr=function(t){return"string"==typeof t?t:t&SHUTTLE?"shuttle":t&THINSHUTTLE?"thinshuttle":null},parseXY=exports.parseXY=function(t){var e,r,n;return e=t.split(","),r=e[0],n=e[1],{x:0|r,y:0|n}},exports.fill=function(t,e,r){var n,i,u,s,o;for(u=new Set2([[t,e]]),n=[t,e],i=function(t,e){if(!u.has(t,e))return u.add(t,e),n.push(t),n.push(e)};n.length>0;)r(s=n.shift(),o=n.shift(),i)&&(i(s+1,o),i(s-1,o),i(s,o+1),i(s,o-1))},exports.fill3=function(t,e,r,n){var i,u,s;for((s=new Set3).add(t,e,r),i=[t,e,r],u=function(t,e,r){if(!s.has(t,e,r))return s.add(t,e,r),i.push(t),i.push(e),i.push(r)};i.length>0;)n(i.shift(),i.shift(),i.shift(),u)},oppositeDir=exports.oppositeDir=function(t){return(t+2)%4},exports.cellMax=function(t){switch(t){case"positive":case"negative":return 4;case"bridge":return 2;case"ribbon":return NUMINS;case"ribbonbridge":return 2*NUMINS;case null:case void 0:return 0;default:return 1}},insLevelOf=function(t){return"ribbon"===t||"ribbonbridge"===t?2:-1!==insNum(t)?3:1},cellAt=function(t,e,r,n,i,u){var s,o;if(o=t.get(e,r),!(i&insLevelOf(o)))return null;if(-1!==(s=insNum(o)))return-1===u||u===s?[e,r,0]:null;switch(o){case"ribbon":return assert(-1!==u),[e,r,u];case"ribbonbridge":return[e,r,n===UP||n===DOWN?u:u+NUMINS];case"nothing":case"thinsolid":return[e,r,0];case"bridge":return[e,r,n===UP||n===DOWN?0:1];case"negative":case"positive":return[e,r,n];default:return null}},connectedCells=function(t,e,r,n){var i,u,s,o,l,a,f,h,c,p,d,b;for(b=t.get(e,r),h=insNum(b),f=1,u=[],c=0,p=(o=function(){if(-1!==h)return f=3,[UP,RIGHT,DOWN,LEFT];switch("ribbon"!==b&&"ribbonbridge"!==b||(h=n%NUMINS,f=2),b){case"nothing":case"thinsolid":case"ribbon":return[UP,RIGHT,DOWN,LEFT];case"bridge":return 0===n?[UP,DOWN]:[LEFT,RIGHT];case"ribbonbridge":return n<NUMINS?[UP,DOWN]:[LEFT,RIGHT];case"positive":case"negative":return[n];default:return[]}}()).length;c<p;c++)s=o[c],l=(d=DIRS[s]).dx,a=d.dy,(i=cellAt(t,e+l,r+a,oppositeDir(s),f,h))&&u.push(i);return u},exports.connectedCells=function(t,e,r,n){return connectedCells(t,e,r,n)},exports.uniqueShuttlesInStates=function(t){var e,r;return r=[],e=new WeakSet,t.forEach(function(t){var n;if(n=t.shuttle,!e.has(n))return e.add(n),r.push(n)}),r.sort(function(t,e){return t.id-e.id}),r},exports.setToArray=function(t){var e;return e=[],t.forEach(function(t){return e.push(t)}),e},exports.ShuttleStateMap=ShuttleStateMap=function(){function t(t){this.shuttles=[],t.forEach(function(t){return function(e){return assert(e.used),t.shuttles.push(e)}}(this)),this.values=void 0}var e;return e=function(t,r,n){var i,u,s,o;if(0!==r){for(r--,o=[],u=0,s=t.length;u<s;u++)(i=t[u])&&o.push(e(i,r,n));return o}null!=t&&n(t)},t.prototype.isDefinedFor=function(t){var e,r,n,i;for(e=0,r=(n=this.shuttles).length;e<r;e++)if(i=n[e],!t.has(i))return!1;return!0},t.prototype.get=function(t){var e,r,n,i,u,s;for(e=this.values,r=0,n=(i=this.shuttles).length;r<n;r++){if(u=i[r],!e)return;s=t.get(u),assert(s),e=e[s.id]}return e},t.prototype.set=function(t,e){var r,n,i,u,s,o,l;if(0===this.shuttles.length)return this.values=e;for(i="values",r=this,n=0,u=(s=this.shuttles).length;n<u;n++){if(o=s[n],!(l=t.get(o)))throw Error("ShuttleStateMap.set on an unbound set");r=r[i]?r[i]:r[i]=[],i=l.id}return r[i]=e},t.prototype.delete=function(t){return this.set(t,void 0)},t.prototype.forEachValue=function(t){return e(this.values,this.shuttles.length,t)},t}(),exports.fillGraph=function(t,e){var r,n,i;for(i=new Set,r=[],(n=function(t){if(!i.has(t))return i.add(t),r.push(t)})(t);r.length>0;)e(r.shift(),n)},chalk=require("chalk"),function(){var t,e,r,n,i;if(!chalk.bgGreen){for(chalk=function(t){return t},i=[],e=0,r=(n=["bgGreen","bgRed","bgWhite","bgBlue","blue","yellow","grey","magenta"]).length;e<r;e++)t=n[e],i.push(chalk[t]=chalk)}}(),chars={positive:function(t){return chalk.bgGreen(t||"+")},negative:function(t){return chalk.bgRed(t||"-")},nothing:function(){return chalk.bgWhite(" ")},thinsolid:function(){return chalk.bgWhite.grey("x")},shuttle:function(t){return chalk.magenta(t||"S")},thinshuttle:function(t){return chalk.magenta.bgWhite(t||"s")},bridge:function(){return chalk.bgBlue("B")},thinbridge:function(){return chalk.blue("b")},ribbon:function(){return chalk.yellow("r")},ribbonbridge:function(){return chalk.yellow.bgBlue("r")}},exports.printCustomGrid=printCustomGrid=function(t,e,r,n){var i,u,s,o,l,a,f,h,c,p,d,b,g,v,S,N,x,T,w,y,E;for(T=t.top,a=t.left,i=t.bottom,x=t.right,null==r&&(r=function(){}),null==n&&(n=process.stdout),T||(T=0),a||(a=0),u=chalk.bold,n.write(u("+ ")),y=o=c=a,p=x;c<=p?o<=p:o>=p;y=c<=p?++o:--o)n.write(u(""+y%10));for(n.write("\n"),E=l=d=T,b=i;d<=b?l<=b:l>=b;E=d<=b?++l:--l){for(n.write(u(E%10+" ")),y=f=g=a,v=x;g<=v?f<=v:f>=v;y=g<=v?++f:--f)"number"==typeof(w=e(y,E))&&(w=shuttleStr(w)),"number"==typeof(s=r(y,E))&&(s%=10),n.write(("function"==typeof chars[w]?chars[w](s):void 0)||(null!=w?(""+w)[0]:";"));n.write("\n")}for(n.write(u("+ ")),y=h=S=a,N=x;S<=N?h<=N:h>=N;y=S<=N?++h:--h)n.write(u(""+y%10));return n.write("\n")},exports.gridExtents=function(t){var e,r,n,i;return i=r=e=n=null,t.forEach(function(t,u,s){if((null===r||t<r)&&(r=t),(null===n||t>n)&&(n=t),(null===i||u<i)&&(i=u),null===e||u>e)return e=u}),{top:i,left:r,bottom:e,right:n}},jsonExtents=function(t){var e,r,n,i;return i=r=e=n=null,function(t){var u,s,o,l,a;o=[];for(u in t)t[u],l=(s=parseXY(u)).x,a=s.y,(null===r||l<r)&&(r=l),(null===n||l>n)&&(n=l),(null===i||a<i)&&(i=a),null===e||a>e?o.push(e=a):o.push(void 0);return o}(t.base?t.base:t),{top:i,left:r,bottom:e,right:n}},exports.printJSONGrid=function(t,e){var r,n;return null==e&&(e=process.stdout),r=jsonExtents(t),n=t.base?function(e,r){return t.shuttles[[e,r]]||t.base[[e,r]]}:function(e,r){return t[[e,r]]},printCustomGrid(r,n,function(){},e)},exports.printGrid=function(t,e,r){return null==r&&(r=process.stdout),printCustomGrid(t,function(t,r){return e.get(t,r)},function(){},r)},exports.deserialize=deserialize=function(t,e,r){var n,i,u,s,o,l,a,f,h,c,p,d,b,g;if("string"==typeof t&&(t=JSON.parse(t)),i=u=-1/0,e)if(null!=t.tw)s=o=0,i=t.tw,u=t.th;else{s=o=1/0,a=null!=(l=t.base)?l:t;for(n in a)d=a[n],b=(f=parseXY(n)).x,g=f.y,b<s&&(s=b),g<o&&(o=g),b>i&&(i=b),g>u&&(u=g);s--,o--,i+=2,u+=2}else s=o=0;if(t.base){h=t.base;for(n in h)d=h[n],b=(c=parseXY(n)).x,g=c.y,"thinbridge"===d&&(d="bridge"),r(b-s,g-o,d,t.shuttles[n])}else{console.log("Loading from old style data");for(n in t)d=t[n],"tw"!==n&&"th"!==n&&(b=(p=parseXY(n)).x,g=p.y,b-=s,g-=o,"shuttle"===d||"thinshuttle"===d?r(b,g,"nothing",d):r(b,g,d,null))}if(e)return{tw:i-s,th:u-o}},exports.deserializeRegion=function(t){var e,r,n,i;return r={base:new Map2,shuttles:new Map2},e=deserialize(t,!0,function(t,e,n,i){if(r.base.set(t,e,n),null!=i)return r.shuttles.set(t,e,i)}),i=e.tw,n=e.th,r.tw=i,r.th=n,r};

}).call(this,require('_process'))
},{"./collections2":12,"./log":15,"_process":22,"assert":11,"chalk":18}],17:[function(require,module,exports){
var Watcher,slice=[].slice;module.exports=Watcher=function(){function r(r){var t;this.forEach=r,"function"!=typeof this.forEach&&(t=this.forEach,this.forEach=function(r){return t.forEach(r)}),this.observers=[]}return r.prototype.forward=function(r){return this.forEach(r),this.observers.push(r)},r.prototype.on=function(r){return this.observers.push(r)},r.prototype.signal=function(){var r,t,o,e;for(r=1<=arguments.length?slice.call(arguments,0):[],t=0,o=(e=this.observers).length;t<o;t++)e[t].apply(null,r)},r}();

},{}],18:[function(require,module,exports){

},{}],19:[function(require,module,exports){
module.exports=function(e){"string"==typeof e&&(e=[e]);for(var n=[].slice.call(arguments,1),o=[],r=0;r<e.length-1;r++)o.push(e[r],n[r]||"");return o.push(e[r]),o.join("")};

},{}],20:[function(require,module,exports){
require("whatwg-fetch"),module.exports=self.fetch.bind(self);

},{"whatwg-fetch":27}],21:[function(require,module,exports){
function Map2(t){if(this.map=new Map,this.size=0,t)for(var e=0;e<t.length;e++){var r=t[e];this.set(r[0],r[1],r[2])}}if(module.exports=Map2,Map2.prototype.get=function(t,e){var r;if(r=this.map.get(t))return r.get(e)},Map2.prototype.has=function(t,e){var r=this.map.get(t);return!!r&&r.has(e)},Map2.prototype.set=function(t,e,r){var n=this.map.get(t);return n||(n=new Map,this.map.set(t,n)),this.size-=n.size,n.set(e,r),this.size+=n.size,this},Map2.prototype.delete=function(t,e){var r=this.map.get(t);if(r){var n=r.delete(e);return n&&this.size--,n}return!1},Map2.prototype.clear=function(){this.map.clear(),this.size=0},Map2.prototype.forEach=function(t){this.map.forEach(function(e,r){e.forEach(function(e,n){t(e,r,n)})})},"undefined"!=typeof Symbol){function iterWithNext(t){var e={};return e.next=t,e[Symbol.iterator]=function(){return e},e}Map2.prototype[Symbol.iterator]=Map2.prototype.entries=function(){var t,e=this.map.entries(),r=null;return iterWithNext(function(){for(var n;null==r||(n=r.next()).done;){var i=e.next();if(i.done)return i;t=i.value[0],r=i.value[1].entries()}var a=n.value[0],o=n.value[1];return{value:[t,a,o],done:!1}})},Map2.prototype.keys=function(){var t=this.entries();return iterWithNext(function(){var e=t.next();return e.done?e:{value:[e.value[0],e.value[1]],done:!1}})},Map2.prototype.values=function(){var t=this.entries();return iterWithNext(function(){var e=t.next();return e.done?e:{value:e.value[2],done:!1}})}}Map2.prototype.inspect=function(t,e){var r=require("util").inspect;if(t<0)return"[Map2]";if(0===this.size)return"{[Map2]}";var n=[];return this.forEach(function(t,i,a){n.push("("+r(t,e)+","+r(i,e)+") : "+r(a,e))}),"{[Map2] "+n.join(", ")+" }"};

},{"util":26}],22:[function(require,module,exports){
function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}var process=module.exports={},cachedSetTimeout,cachedClearTimeout;!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var queue=[],draining=!1,currentQueue,queueIndex=-1;process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};

},{}],23:[function(require,module,exports){
function Set2(t){if(this.map=new Map,this.size=0,t)for(var e=0;e<t.length;e++)this.add(t[e][0],t[e][1])}module.exports=Set2,Set2.prototype.subset=function(t){return this.map.get(t)},Set2.prototype.has=function(t,e){var r=this.map.get(t);return!!r&&r.has(e)},Set2.prototype.add=function(t,e){var r=this.map.get(t);return r||(r=new Set,this.map.set(t,r)),this.size-=r.size,r.add(e),this.size+=r.size,this},Set2.prototype.delete=function(t,e){var r=this.map.get(t);return!!r&&(!!r.delete(e)&&(this.size--,0===r.size&&this.map.delete(t),!0))},Set2.prototype.deleteAll=function(t){var e;return!!(e=this.map.get(t))&&(this.size-=e.size,this.map.delete(t),!0)},Set2.prototype.clear=function(){this.map.clear(),this.size=0},Set2.prototype.forEach=function(t){this.map.forEach(function(e,r){e.forEach(function(e){t(r,e)})})},Set2.prototype[Symbol.iterator]=Set2.prototype.values=Set2.prototype.entries=function(){var t,e=this.map.entries(),r=null,i={next:function(){for(var i;null==r||(i=r.next()).done;){var n=e.next();if(n.done)return n;t=n.value[0],r=n.value[1].values()}var o=i.value;return{value:[t,o],done:!1}}};return i[Symbol.iterator]=function(){return i},i},Set2.prototype.inspect=function(t,e){var r=require("util").inspect;if(t<0)return"[Set2]";var i=[];return this.forEach(function(t,n){i.push("("+r(t,e)+","+r(n,e)+")")}),assert.equal(i.length,this.size),"{[Set2] "+i.join(", ")+" }"};

},{"util":26}],24:[function(require,module,exports){
"function"==typeof Object.create?module.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};

},{}],25:[function(require,module,exports){
module.exports=function(o){return o&&"object"==typeof o&&"function"==typeof o.copy&&"function"==typeof o.fill&&"function"==typeof o.readUInt8};

},{}],26:[function(require,module,exports){
(function (process,global){
function inspect(e,r){var t={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(t.depth=arguments[2]),arguments.length>=4&&(t.colors=arguments[3]),isBoolean(r)?t.showHidden=r:r&&exports._extend(t,r),isUndefined(t.showHidden)&&(t.showHidden=!1),isUndefined(t.depth)&&(t.depth=2),isUndefined(t.colors)&&(t.colors=!1),isUndefined(t.customInspect)&&(t.customInspect=!0),t.colors&&(t.stylize=stylizeWithColor),formatValue(t,e,t.depth)}function stylizeWithColor(e,r){var t=inspect.styles[r];return t?"["+inspect.colors[t][0]+"m"+e+"["+inspect.colors[t][1]+"m":e}function stylizeNoColor(e,r){return e}function arrayToHash(e){var r={};return e.forEach(function(e,t){r[e]=!0}),r}function formatValue(e,r,t){if(e.customInspect&&r&&isFunction(r.inspect)&&r.inspect!==exports.inspect&&(!r.constructor||r.constructor.prototype!==r)){var n=r.inspect(t,e);return isString(n)||(n=formatValue(e,n,t)),n}var i=formatPrimitive(e,r);if(i)return i;var o=Object.keys(r),s=arrayToHash(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),isError(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return formatError(r);if(0===o.length){if(isFunction(r)){var u=r.name?": "+r.name:"";return e.stylize("[Function"+u+"]","special")}if(isRegExp(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(isDate(r))return e.stylize(Date.prototype.toString.call(r),"date");if(isError(r))return formatError(r)}var c="",a=!1,l=["{","}"];if(isArray(r)&&(a=!0,l=["[","]"]),isFunction(r)&&(c=" [Function"+(r.name?": "+r.name:"")+"]"),isRegExp(r)&&(c=" "+RegExp.prototype.toString.call(r)),isDate(r)&&(c=" "+Date.prototype.toUTCString.call(r)),isError(r)&&(c=" "+formatError(r)),0===o.length&&(!a||0==r.length))return l[0]+c+l[1];if(t<0)return isRegExp(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special");e.seen.push(r);var p;return p=a?formatArray(e,r,t,s,o):o.map(function(n){return formatProperty(e,r,t,s,n,a)}),e.seen.pop(),reduceToSingleString(p,c,l)}function formatPrimitive(e,r){if(isUndefined(r))return e.stylize("undefined","undefined");if(isString(r)){var t="'"+JSON.stringify(r).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(t,"string")}return isNumber(r)?e.stylize(""+r,"number"):isBoolean(r)?e.stylize(""+r,"boolean"):isNull(r)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,r,t,n,i){for(var o=[],s=0,u=r.length;s<u;++s)hasOwnProperty(r,String(s))?o.push(formatProperty(e,r,t,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(formatProperty(e,r,t,n,i,!0))}),o}function formatProperty(e,r,t,n,i,o){var s,u,c;if((c=Object.getOwnPropertyDescriptor(r,i)||{value:r[i]}).get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),hasOwnProperty(n,i)||(s="["+i+"]"),u||(e.seen.indexOf(c.value)<0?(u=isNull(t)?formatValue(e,c.value,null):formatValue(e,c.value,t-1)).indexOf("\n")>-1&&(u=o?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n")):u=e.stylize("[Circular]","special")),isUndefined(s)){if(o&&i.match(/^\d+$/))return u;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function reduceToSingleString(e,r,t){var n=0;return e.reduce(function(e,r){return n++,r.indexOf("\n")>=0&&n++,e+r.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?t[0]+(""===r?"":r+"\n ")+" "+e.join(",\n  ")+" "+t[1]:t[0]+r+" "+e.join(", ")+" "+t[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return e<10?"0"+e.toString(10):e.toString(10)}function timestamp(){var e=new Date,r=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],r].join(" ")}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var formatRegExp=/%[sdj%]/g;exports.format=function(e){if(!isString(e)){for(var r=[],t=0;t<arguments.length;t++)r.push(inspect(arguments[t]));return r.join(" ")}for(var t=1,n=arguments,i=n.length,o=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(t>=i)return e;switch(e){case"%s":return String(n[t++]);case"%d":return Number(n[t++]);case"%j":try{return JSON.stringify(n[t++])}catch(e){return"[Circular]"}default:return e}}),s=n[t];t<i;s=n[++t])isNull(s)||!isObject(s)?o+=" "+s:o+=" "+inspect(s);return o},exports.deprecate=function(e,r){if(isUndefined(global.process))return function(){return exports.deprecate(e,r).apply(this,arguments)};if(!0===process.noDeprecation)return e;var t=!1;return function(){if(!t){if(process.throwDeprecation)throw new Error(r);process.traceDeprecation?console.trace(r):console.error(r),t=!0}return e.apply(this,arguments)}};var debugs={},debugEnviron;exports.debuglog=function(e){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){var r=process.pid;debugs[e]=function(){var t=exports.format.apply(exports,arguments);console.error("%s %d: %s",e,r,t)}}else debugs[e]=function(){};return debugs[e]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(e,r){if(!r||!isObject(r))return e;for(var t=Object.keys(r),n=t.length;n--;)e[t[n]]=r[t[n]];return e};

}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./support/isBuffer":25,"_process":22,"inherits":24}],27:[function(require,module,exports){
!function(t){"use strict";function e(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function r(t){return"string"!=typeof t&&(t=String(t)),t}function o(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return m.iterable&&(e[Symbol.iterator]=function(){return e}),e}function n(t){this.map={},t instanceof n?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function i(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function s(t){return new Promise(function(e,r){t.onload=function(){e(t.result)},t.onerror=function(){r(t.error)}})}function a(t){var e=new FileReader,r=s(e);return e.readAsArrayBuffer(t),r}function u(t){var e=new FileReader,r=s(e);return e.readAsText(t),r}function h(t){for(var e=new Uint8Array(t),r=new Array(e.length),o=0;o<e.length;o++)r[o]=String.fromCharCode(e[o]);return r.join("")}function f(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function d(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"==typeof t)this._bodyText=t;else if(m.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(m.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(m.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(m.arrayBuffer&&m.blob&&v(t))this._bodyArrayBuffer=f(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!m.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!B(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=f(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):m.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},m.blob&&(this.blob=function(){var t=i(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?i(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(a)}),this.text=function(){var t=i(this);if(t)return t;if(this._bodyBlob)return u(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(h(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},m.formData&&(this.formData=function(){return this.text().then(p)}),this.json=function(){return this.text().then(JSON.parse)},this}function y(t){var e=t.toUpperCase();return _.indexOf(e)>-1?e:t}function l(t,e){var r=(e=e||{}).body;if(t instanceof l){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new n(t.headers)),this.method=t.method,this.mode=t.mode,r||null==t._bodyInit||(r=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new n(e.headers)),this.method=y(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&r)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(r)}function p(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var r=t.split("="),o=r.shift().replace(/\+/g," "),n=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(o),decodeURIComponent(n))}}),e}function c(t){var e=new n;return t.split(/\r?\n/).forEach(function(t){var r=t.split(":"),o=r.shift().trim();if(o){var n=r.join(":").trim();e.append(o,n)}}),e}function b(t,e){e||(e={}),this.type="default",this.status="status"in e?e.status:200,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new n(e.headers),this.url=e.url||"",this._initBody(t)}if(!t.fetch){var m={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(m.arrayBuffer)var w=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],v=function(t){return t&&DataView.prototype.isPrototypeOf(t)},B=ArrayBuffer.isView||function(t){return t&&w.indexOf(Object.prototype.toString.call(t))>-1};n.prototype.append=function(t,o){t=e(t),o=r(o);var n=this.map[t];this.map[t]=n?n+","+o:o},n.prototype.delete=function(t){delete this.map[e(t)]},n.prototype.get=function(t){return t=e(t),this.has(t)?this.map[t]:null},n.prototype.has=function(t){return this.map.hasOwnProperty(e(t))},n.prototype.set=function(t,o){this.map[e(t)]=r(o)},n.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},n.prototype.keys=function(){var t=[];return this.forEach(function(e,r){t.push(r)}),o(t)},n.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),o(t)},n.prototype.entries=function(){var t=[];return this.forEach(function(e,r){t.push([r,e])}),o(t)},m.iterable&&(n.prototype[Symbol.iterator]=n.prototype.entries);var _=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];l.prototype.clone=function(){return new l(this,{body:this._bodyInit})},d.call(l.prototype),d.call(b.prototype),b.prototype.clone=function(){return new b(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new n(this.headers),url:this.url})},b.error=function(){var t=new b(null,{status:0,statusText:""});return t.type="error",t};var A=[301,302,303,307,308];b.redirect=function(t,e){if(-1===A.indexOf(e))throw new RangeError("Invalid status code");return new b(null,{status:e,headers:{location:t}})},t.Headers=n,t.Request=l,t.Response=b,t.fetch=function(t,e){return new Promise(function(r,o){var n=new l(t,e),i=new XMLHttpRequest;i.onload=function(){var t={status:i.status,statusText:i.statusText,headers:c(i.getAllResponseHeaders()||"")};t.url="responseURL"in i?i.responseURL:t.headers.get("X-Request-URL");var e="response"in i?i.response:i.responseText;r(new b(e,t))},i.onerror=function(){o(new TypeError("Network request failed"))},i.ontimeout=function(){o(new TypeError("Network request failed"))},i.open(n.method,n.url,!0),"include"===n.credentials&&(i.withCredentials=!0),"responseType"in i&&m.blob&&(i.responseType="blob"),n.headers.forEach(function(t,e){i.setRequestHeader(e,t)}),i.send(void 0===n._bodyInit?null:n._bodyInit)})},t.fetch.polyfill=!0}}("undefined"!=typeof self?self:this);

},{}]},{},[3]);
